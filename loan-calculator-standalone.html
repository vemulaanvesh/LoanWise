
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanWise - Smart EMI & Prepayment Calculator | Make Smarter Loan Decisions</title>
    <meta name="description" content="Free loan calculator with variable ROI and EMI support. Track prepayments, save thousands in interest, and plan your loan payoff strategy. 100% private - your data stays in your browser.">
    <meta name="keywords" content="loan calculator, EMI calculator, prepayment calculator, interest calculator, loan projection, ROI calculator, home loan calculator, personal loan calculator">
    <meta name="author" content="Snickers9">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // Lucide Icons as inline SVG components
        const Calculator = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="4" y="2" width="16" height="20" rx="2"/>
                <line x1="8" y1="6" x2="16" y2="6"/>
                <line x1="16" y1="10" x2="16" y2="10.01"/>
                <line x1="12" y1="10" x2="12" y2="10.01"/>
                <line x1="8" y1="10" x2="8" y2="10.01"/>
                <line x1="16" y1="14" x2="16" y2="14.01"/>
                <line x1="12" y1="14" x2="12" y2="14.01"/>
                <line x1="8" y1="14" x2="8" y2="14.01"/>
                <line x1="16" y1="18" x2="16" y2="18.01"/>
                <line x1="12" y1="18" x2="12" y2="18.01"/>
                <line x1="8" y1="18" x2="8" y2="18.01"/>
            </svg>
        );

        const Calendar = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
        );

        const DollarSign = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
            </svg>
        );

        const PieChart = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21.21 15.89A10 10 0 1 1 8 2.83"/>
                <path d="M22 12A10 10 0 0 0 12 2v10z"/>
            </svg>
        );

        const Download = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
        );

        const TrendingUp = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
                <polyline points="17 6 23 6 23 12"/>
            </svg>
        );

        const TrendingDown = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
                <polyline points="17 18 23 18 23 12"/>
            </svg>
        );
        
        const AlertCircle = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
        );

        const Zap = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </svg>
        );

        const Target = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <circle cx="12" cy="12" r="6"/>
                <circle cx="12" cy="12" r="2"/>
            </svg>
        );

        const Award = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="8" r="7"/>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
            </svg>
        );

        // LoanWise Logo Component
        const LoanWiseLogo = ({ size = "48" }) => (
            <svg width={size} height={size} viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                {/* Gradient Definition */}
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{stopColor: '#fbbf24', stopOpacity: 1}} />
                        <stop offset="100%" style={{stopColor: '#f59e0b', stopOpacity: 1}} />
                    </linearGradient>
                    <linearGradient id="bookGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style={{stopColor: '#818cf8', stopOpacity: 1}} />
                        <stop offset="100%" style={{stopColor: '#6366f1', stopOpacity: 1}} />
                    </linearGradient>
                </defs>
                
                {/* Book/Wisdom Symbol */}
                <path d="M20 20 L20 70 L80 70 L80 20 Z" fill="url(#bookGradient)" stroke="white" strokeWidth="2"/>
                <path d="M50 20 L50 70" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                <path d="M30 35 L45 35 M30 45 L45 45 M30 55 L45 55" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                <path d="M55 35 L70 35 M55 45 L70 45 M55 55 L70 55" stroke="white" strokeWidth="2" strokeLinecap="round"/>
                
                {/* Coin/Dollar Symbol */}
                <circle cx="75" cy="30" r="18" fill="url(#logoGradient)" stroke="white" strokeWidth="2"/>
                <text x="75" y="38" textAnchor="middle" fill="white" fontSize="20" fontWeight="bold" fontFamily="Arial">₹</text>
                
                {/* Wisdom Cap */}
                <path d="M15 22 L50 10 L85 22" stroke="#fbbf24" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" fill="none"/>
            </svg>
        );

        function SmartLoanProjectionCalculator() {
          // Load from localStorage or use defaults
          const loadFromStorage = (key, defaultValue) => {
            try {
              const saved = localStorage.getItem(key);
              return saved ? JSON.parse(saved) : defaultValue;
            } catch {
              return defaultValue;
            }
          };

          const normalizeLoanData = (ld) => ({
            startingBalance: ld?.startingBalance ?? 0,
            startMonth: ld?.startMonth ?? 'Jan',
            startYear: ld?.startYear ?? new Date().getFullYear(),
            // Bank calculators often depend on these two dates
            disbursements: ld?.disbursements ?? [], // Array of {date: 'YYYY-MM-DD', amount: number}
            emiStartDate: ld?.emiStartDate ?? '', // YYYY-MM-DD
            // Common bank bases: ACT/365, ACT/360 (some products), ACT/ACT
            dayCountBasis: 'ACT_365' // Fixed to standard banking convention
          });

          const [currentProfile, setCurrentProfile] = useState(() => 
            loadFromStorage('currentProfile', 'Default')
          );
          
          const [profiles, setProfiles] = useState(() => 
            loadFromStorage('loanProfiles', {
              'Default': {
                loanData: {
            startingBalance: 0,
            startMonth: 'Jan',
            startYear: new Date().getFullYear(),
            emiStartDate: '',
            dayCountBasis: 'ACT_365'
                },
                roiPeriods: [],
                emiPeriods: [],
                prepayments: [],
                disbursements: []
              }
            })
          );

          const currentProfileData = profiles[currentProfile] || profiles['Default'];
          
          const [loanData, setLoanData] = useState(() => normalizeLoanData(currentProfileData.loanData));
          const [roiPeriods, setRoiPeriods] = useState(currentProfileData.roiPeriods);
          const [emiPeriods, setEmiPeriods] = useState(currentProfileData.emiPeriods);
          const [prepayments, setPrepayments] = useState(currentProfileData.prepayments);
          const [disbursements, setDisbursements] = useState(currentProfileData.disbursements || []);
          const [newDisbursement, setNewDisbursement] = useState({ date: '', amount: '' });

          const [newRoiPeriod, setNewRoiPeriod] = useState({
            month: 'Jan',
            year: new Date().getFullYear(),
            roi: ''
          });

          const [newEmiPeriod, setNewEmiPeriod] = useState({
            month: 'Jan',
            year: new Date().getFullYear(),
            emi: ''
          });

          const [newPrepayment, setNewPrepayment] = useState({
            month: 'Jan',
            year: new Date().getFullYear(),
            amount: ''
          });

          const [showAllRows, setShowAllRows] = useState(false);
          const [showProfileModal, setShowProfileModal] = useState(false);
          const [showDebugModal, setShowDebugModal] = useState(false);
          const [showRecoveryModal, setShowRecoveryModal] = useState(false);
          const [showShareModal, setShowShareModal] = useState(false);
          const [newProfileName, setNewProfileName] = useState('');
          const rowsToShow = 12; // Fallback when current month not found

          // Save to localStorage whenever data changes
          useEffect(() => {
            const updatedProfiles = {
              ...profiles,
              [currentProfile]: {
                loanData,
                roiPeriods,
                emiPeriods,
                prepayments,
                disbursements
              }
            };
            setProfiles(updatedProfiles);
            localStorage.setItem('loanProfiles', JSON.stringify(updatedProfiles));
            localStorage.setItem('currentProfile', JSON.stringify(currentProfile));
          }, [loanData, roiPeriods, emiPeriods, prepayments, disbursements, currentProfile]);

          const calculateTenure = (principal, emi, rate) => {
            const r = rate / (12 * 100);
            if (principal <= 0) return 0;
            if (emi <= principal * r) return 999;
            const n = Math.log(emi / (emi - principal * r)) / Math.log(1 + r);
            return n; // Return exact value, don't round here
          };

          const projectionData = useMemo(() => {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const hasDisbursements = disbursements.length > 0;
            const initialPrincipal = hasDisbursements ? 0 : (loanData.startingBalance || 0);
            let currentBalance = initialPrincipal;
            let currentMonth = months.indexOf(loanData.startMonth);
            let currentYear = loanData.startYear;
            const results = [];
            let totalInterestPaid = 0;
            let totalPrincipalPaid = 0;
            let totalPrepaymentsMade = 0;
            let totalDisbursementsMade = 0;
            let maxBalance = currentBalance;
            let iteration = 0;
            const maxIterations = 1000; // Increased from 300 to handle longer tenures

            // Create ROI map sorted by date
            const roiMap = {};
            const sortedRoiPeriods = [...roiPeriods].sort((a, b) => {
              if (a.year !== b.year) return a.year - b.year;
              return months.indexOf(a.month) - months.indexOf(b.month);
            });
            
            // Create EMI map sorted by date
            const emiMap = {};
            const sortedEmiPeriods = [...emiPeriods].sort((a, b) => {
              if (a.year !== b.year) return a.year - b.year;
              return months.indexOf(a.month) - months.indexOf(b.month);
            });
            
            // Function to get ROI for a specific month/year
            const getRoiForMonth = (month, year) => {
              const monthKey = `${month}-${year}`;
              if (roiMap[monthKey] !== undefined) {
                return roiMap[monthKey];
              }
              
              // Find the applicable ROI (most recent ROI period before or at this month)
              let applicableRoi = sortedRoiPeriods[0]?.roi || 0;
              for (const period of sortedRoiPeriods) {
                const periodMonthIdx = months.indexOf(period.month);
                const currentMonthIdx = months.indexOf(month);
                
                if (period.year < year || (period.year === year && periodMonthIdx <= currentMonthIdx)) {
                  applicableRoi = period.roi;
                } else {
                  break;
                }
              }
              
              roiMap[monthKey] = applicableRoi;
              return applicableRoi;
            };

            // Function to get EMI for a specific month/year
            const getEmiForMonth = (month, year) => {
              const monthKey = `${month}-${year}`;
              if (emiMap[monthKey] !== undefined) {
                return emiMap[monthKey];
              }
              
              // Find the applicable EMI (most recent EMI period before or at this month)
              let applicableEmi = sortedEmiPeriods[0]?.emi || 0;
              for (const period of sortedEmiPeriods) {
                const periodMonthIdx = months.indexOf(period.month);
                const currentMonthIdx = months.indexOf(month);
                
                if (period.year < year || (period.year === year && periodMonthIdx <= currentMonthIdx)) {
                  applicableEmi = period.emi;
                } else {
                  break;
                }
              }
              
              emiMap[monthKey] = applicableEmi;
              return applicableEmi;
            };

            const prepaymentMap = {};
            prepayments.forEach(p => {
              const key = `${p.month}-${p.year}`;
              prepaymentMap[key] = (prepaymentMap[key] || 0) + p.amount;
            });
            
            // Debug: Log prepayment data
            console.log('========================================');
            console.log('PREPAYMENTS DATA');
            console.log('========================================');
            console.log('Total Prepayments Entered:', prepayments.length);
            console.log('Prepayments:', prepayments);
            console.log('Prepayment Map Keys:', Object.keys(prepaymentMap));
            console.log('Total Prepayment Amount:', '₹' + (prepayments.reduce((sum, p) => sum + (p.amount || 0), 0) / 100000).toFixed(2) + 'L');
            console.log('========================================');

            const disbursementMap = {};
            disbursements.forEach(d => {
              const date = new Date(d.date);
              const month = months[date.getMonth()];
              const year = date.getFullYear();
              const key = `${month}-${year}`;
              disbursementMap[key] = (disbursementMap[key] || 0) + d.amount;
            });

            // Check if there are disbursements scheduled for or after a given month/year
            const hasPendingDisbursements = (monthIdx, year) => {
              const keys = Object.keys(disbursementMap);
              return keys.some(key => {
                const [mStr, yStr] = key.split('-');
                const mIdx = months.indexOf(mStr);
                const yNum = parseInt(yStr, 10);
                return yNum > year || (yNum === year && mIdx >= monthIdx);
              });
            };

            // Helper function to calculate days between dates
            const getDaysBetween = (date1, date2) => {
              if (!date1 || !date2) return 30; // fallback to 30 days if dates not provided
              const d1 = new Date(date1 + 'T00:00:00');
              const d2 = new Date(date2 + 'T00:00:00');
              return Math.abs(Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24)));
            };

            // Helper function to get next EMI date
            const getNextEmiDate = (currentDate, emiDay) => {
              if (!currentDate) return null;
              const date = new Date(currentDate + 'T00:00:00');
              const nextMonth = new Date(date.getFullYear(), date.getMonth() + 1, emiDay);
              return nextMonth.toISOString().split('T')[0];
            };

            // Helper function to calculate daily interest
            const calculateDailyInterest = (principal, annualRate, days, dayCountBasis) => {
              let daysInYear;
              switch (dayCountBasis) {
                case 'ACT_365':
                  daysInYear = 365;
                  break;
                case 'ACT_360':
                  daysInYear = 360;
                  break;
                case 'ACT_ACT':
                  // For ACT/ACT, we'd need to know if it's a leap year, but for simplicity using 365.25
                  daysInYear = 365.25;
                  break;
                default:
                  daysInYear = 365;
              }
              const dailyRate = annualRate / (100 * daysInYear);
              return Math.round(principal * dailyRate * days);
            };

            // Debug: Log calculation start
            if (prepayments.length > 0) {
              console.log('');
              console.log('STARTING LOAN CALCULATION WITH PREPAYMENTS');
              console.log('  • Starting Balance:', '₹' + (initialPrincipal / 100000).toFixed(2) + 'L');
              console.log('  • Start Month/Year:', loanData.startMonth, loanData.startYear);
              console.log('  • Prepayment Count:', prepayments.length);
              console.log('  • Prepayments:', prepayments.map(p => `₹${(p.amount / 100000).toFixed(2)}L in ${p.month} ${p.year}`).join(', '));
              console.log('');
            }
            
            while ((currentBalance > 0.01 || hasPendingDisbursements(currentMonth, currentYear)) && iteration < maxIterations) {
              iteration++;
              const monthKey = `${months[currentMonth]}-${currentYear}`;
              const openingBalance = currentBalance;

              // Get ROI and EMI for current month
              const currentRoi = getRoiForMonth(months[currentMonth], currentYear);
              const currentEmi = getEmiForMonth(months[currentMonth], currentYear);

              // Calculate daily interest accrual on opening balance (before disbursements)
              let interest = 0;
              if (loanData.emiStartDate) {
                // Calculate interest for the period between EMI dates
                const emiDay = new Date(loanData.emiStartDate + 'T00:00:00').getDate();

                // Calculate the previous EMI date
                let prevEmiDate;
                if (iteration === 1) {
                  prevEmiDate = loanData.emiStartDate;
                } else {
                  // For subsequent iterations, previous EMI was last month on the same day
                  const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                  const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                  prevEmiDate = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(emiDay).padStart(2, '0')}`;
                }

                // Current EMI date for this month
                const currentEmiDate = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(emiDay).padStart(2, '0')}`;
                const daysBetweenEmis = getDaysBetween(prevEmiDate, currentEmiDate);

                // Calculate interest on the entire opening balance for the days between EMIs
                interest = calculateDailyInterest(openingBalance, currentRoi, daysBetweenEmis, loanData.dayCountBasis || 'ACT_365');
              } else {
                // Fallback to monthly calculation if dates not provided
                const monthlyRate = currentRoi / (12 * 100);
                interest = Math.round(openingBalance * monthlyRate);
              }

              // Add disbursements for this month (before EMI calculation)
              const disbursementThisMonth = disbursementMap[monthKey] || 0;
              const balanceAfterDisbursement = openingBalance + disbursementThisMonth;
              currentBalance = balanceAfterDisbursement;
              maxBalance = Math.max(maxBalance, currentBalance);

              // Handle last month or cases where balance is less than EMI
              let emiPrincipal;
              let actualEMI;
              const totalDue = balanceAfterDisbursement + interest;
              
              if (totalDue <= currentEmi) {
                // Last month - pay remaining balance + interest
                actualEMI = totalDue;
                emiPrincipal = openingBalance;
              } else {
                // Normal month
                actualEMI = currentEmi;
                emiPrincipal = Math.max(0, currentEmi - interest);
                
                // Check if EMI is sufficient to cover interest
                if (emiPrincipal <= 0) {
                  console.warn('EMI is not sufficient to cover monthly interest. Loan will not reduce.');
                  emiPrincipal = 0;
                }
              }
              
              const balanceAfterEMI = Math.max(0, balanceAfterDisbursement - emiPrincipal);

              const prepaymentThisMonth = prepaymentMap[monthKey] || 0;
              const actualPrepayment = balanceAfterEMI > prepaymentThisMonth
                ? prepaymentThisMonth
                : balanceAfterEMI;

              const closingBalance = Math.max(0, balanceAfterEMI - actualPrepayment);
              
              // Debug: Log when prepayment is applied
              if (prepaymentThisMonth > 0) {
                console.log(`Prepayment Applied in ${monthKey}:`, {
                  planned: '₹' + (prepaymentThisMonth / 100000).toFixed(2) + 'L',
                  actual: '₹' + (actualPrepayment / 100000).toFixed(2) + 'L',
                  balanceBeforePrepayment: '₹' + (balanceAfterEMI / 100000).toFixed(2) + 'L',
                  balanceAfterPrepayment: '₹' + (closingBalance / 100000).toFixed(2) + 'L'
                });
              }
              
              // Calculate months reduced ONLY if there's a prepayment
              let monthsReducedByPrepayment = 0;
              if (actualPrepayment > 0) {
                const tenureBeforePrepayment = calculateTenure(balanceAfterEMI, currentEmi, currentRoi);
                const tenureAfterPrepayment = calculateTenure(closingBalance, currentEmi, currentRoi);
                // Use ceiling to avoid undercounting saved months (bank-style rounding up)
                monthsReducedByPrepayment = Math.max(0, Math.ceil(tenureBeforePrepayment - tenureAfterPrepayment));
              }

              totalInterestPaid += interest;
              totalPrincipalPaid += emiPrincipal + actualPrepayment;
              totalPrepaymentsMade += actualPrepayment;
              totalDisbursementsMade += disbursementThisMonth;

              // Principal vs Interest ratio should ONLY compare EMI principal to interest (not including prepayment)
              const emiPrincipalVsInterestRatio = interest > 0 ? (emiPrincipal / interest) : 0;
              
              // Total principal paid this month (for display purposes)
              const principalPaidThisMonth = emiPrincipal + actualPrepayment;

              results.push({
                month: `${months[currentMonth]} ${currentYear}`,
                monthKey,
                openingBalance,
                disbursement: disbursementThisMonth,
                interest,
                emiPrincipal,
                balanceAfterEMI,
                prepayment: actualPrepayment,
                closingBalance,
                monthsReduced: monthsReducedByPrepayment,
                totalInterestPaid,
                totalPrincipalPaid,
                principalPaidThisMonth,
                principalVsInterestRatio: emiPrincipalVsInterestRatio,
                actualEMI,
                roi: currentRoi,
                emi: currentEmi
              });

              currentBalance = closingBalance;
              
              // Break if balance is effectively zero
              if (closingBalance < 0.01) {
                console.log(`WITH-PREPAYMENT Loan completed in month ${iteration}: ${monthKey}`);
                break;
              }
              
              currentMonth = (currentMonth + 1) % 12;
              if (currentMonth === 0) currentYear++;
            }

            // Calculate theoretical tenure using EMI formula (bank's method)
            const startingRoi = sortedRoiPeriods[0]?.roi || 0;
            const startingEmi = sortedEmiPeriods[0]?.emi || 0;
            const theoreticalTenure = Math.ceil(calculateTenure(initialPrincipal, startingEmi, startingRoi));

            // Calculate minimum EMI and check sufficiency
            // Find the maximum interest paid in any single month (this is the minimum EMI needed)
            const maxMonthlyInterest = results.length > 0 ? Math.max(...results.map(r => r.interest)) : 0;
            const minEMIRequired = maxMonthlyInterest > 0 ? Math.ceil(maxMonthlyInterest * 1.01) : 0; // 1% buffer
            
            // Simple and accurate check: If the loan completes successfully, EMI is sufficient!
            // A loan "completes" when:
            // 1. Balance reaches near zero (< 0.01)
            // 2. Didn't hit the iteration limit (which would mean infinite loop)
            // 3. Has a valid schedule with at least one month
            const hasSchedule = results.length > 0;
            const balanceCleared = currentBalance < 0.01;
            const didNotTimeout = iteration < maxIterations;
            
            // Additional check: At least 90% of months have positive principal payment
            const monthsWithPositivePrincipal = results.filter(row => row.emiPrincipal > 0).length;
            const principalPaymentRatio = hasSchedule ? monthsWithPositivePrincipal / results.length : 0;
            const mostMonthsPositive = principalPaymentRatio >= 0.9;
            
            const isEMISufficient = hasSchedule && balanceCleared && didNotTimeout && mostMonthsPositive;
            
            // Debug logging for EMI sufficiency check
            if (!isEMISufficient && hasSchedule) {
              console.log('EMI Sufficiency Check Failed:', {
                hasSchedule,
                balanceCleared,
                currentBalance,
                didNotTimeout,
                iteration,
                maxIterations,
                mostMonthsPositive,
                principalPaymentRatio,
                monthsWithPositivePrincipal,
                totalMonths: results.length
              });
            }

            // Calculate without prepayment scenario (separate simulation)
            // This simulates what would happen with same EMI, ROI, and disbursements but NO prepayments
            console.log('');
            console.log('STARTING WITHOUT-PREPAYMENT SCENARIO...');
            console.log('  • Starting Balance:', '₹' + (initialPrincipal / 100000).toFixed(2) + 'L');
            console.log('  • Start Month/Year:', loanData.startMonth, loanData.startYear);
            console.log('');
            
            let withoutPrepaymentBalance = initialPrincipal;
            let withoutPrepaymentMonths = 0;
            let withoutPrepaymentInterestTotal = 0;
            const maxIterationsWithoutPrep = 1000;

            // Use separate month/year counters for without-prepayment simulation
            let wpMonth = months.indexOf(loanData.startMonth);
            let wpYear = loanData.startYear;
            let wpIteration = 0;

            let wpDebugCount = 0;
            while ((withoutPrepaymentBalance > 0.01 || hasPendingDisbursements(wpMonth, wpYear)) && wpIteration < maxIterationsWithoutPrep) {
              wpIteration++;
              const monthKey = `${months[wpMonth]}-${wpYear}`;
              const wpOpeningBalance = withoutPrepaymentBalance;
              
              // Debug first few months
              if (wpDebugCount < 3) {
                console.log(`  Month ${wpIteration} (${monthKey}): Balance ₹${(wpOpeningBalance / 100000).toFixed(2)}L`);
                wpDebugCount++;
              }

              // Get ROI and EMI for this month (same as main calculation)
              const currentRoi = getRoiForMonth(months[wpMonth], wpYear);
              const currentEmi = getEmiForMonth(months[wpMonth], wpYear);
              
              // Calculate interest on opening balance (BEFORE disbursements - same as main calculation)
              let interest = 0;
              if (loanData.emiStartDate) {
                const emiDay = new Date(loanData.emiStartDate + 'T00:00:00').getDate();
                let prevEmiDate;
                if (wpIteration === 1) {
                  prevEmiDate = loanData.emiStartDate;
                } else {
                  const prevMonth = wpMonth === 0 ? 11 : wpMonth - 1;
                  const prevYear = wpMonth === 0 ? wpYear - 1 : wpYear;
                  prevEmiDate = `${prevYear}-${String(prevMonth + 1).padStart(2, '0')}-${String(emiDay).padStart(2, '0')}`;
                }
                const currentEmiDate = `${wpYear}-${String(wpMonth + 1).padStart(2, '0')}-${String(emiDay).padStart(2, '0')}`;
                const daysBetweenEmis = getDaysBetween(prevEmiDate, currentEmiDate);
                interest = calculateDailyInterest(wpOpeningBalance, currentRoi, daysBetweenEmis, loanData.dayCountBasis || 'ACT_365');
              } else {
                const monthlyRate = currentRoi / (12 * 100);
                interest = Math.round(wpOpeningBalance * monthlyRate);
              }
              
              // Add disbursements (same as main calculation)
              const disbursementThisMonth = disbursementMap[monthKey] || 0;
              const wpBalanceAfterDisbursement = wpOpeningBalance + disbursementThisMonth;
              
              // CRITICAL: Ensure NO prepayments are applied here
              // This is the without-prepayment scenario
              const checkPrepayment = prepaymentMap[monthKey] || 0;
              if (checkPrepayment > 0 && wpDebugCount <= 5) {
                console.log(`  Note: Prepayment of ₹${(checkPrepayment / 100000).toFixed(2)}L scheduled for ${monthKey} (NOT applied in without-prepayment scenario)`);
              }
              
              // Calculate principal payment (no prepayments in this scenario)
              // MATCH THE EXACT LOGIC FROM MAIN CALCULATION
              let wpEmiPrincipal;
              let wpActualEMI;
              const wpTotalDue = wpBalanceAfterDisbursement + interest;
              
              if (wpTotalDue <= currentEmi) {
                // Last month - pay remaining balance + interest
                wpActualEMI = wpTotalDue;
                wpEmiPrincipal = wpBalanceAfterDisbursement;
                withoutPrepaymentBalance = 0; // Loan complete
              } else {
                // Normal month
                wpActualEMI = currentEmi;
                wpEmiPrincipal = Math.max(0, currentEmi - interest);
                
                // MATCH MAIN CALCULATION: If EMI is insufficient, set principal to 0 but CONTINUE
                // This matches the behavior in the main loop at line ~452-455
                if (wpEmiPrincipal <= 0) {
                  wpEmiPrincipal = 0;
                  // Don't break - continue to next month where EMI might increase
                }
                
                // Update balance (NO prepayments applied here)
                withoutPrepaymentBalance = Math.max(0, wpBalanceAfterDisbursement - wpEmiPrincipal);
              }
              
              withoutPrepaymentInterestTotal += interest;
              withoutPrepaymentMonths++;
              
              // Debug: Show when we're getting close to completion
              if (withoutPrepaymentBalance < 100000 && wpDebugCount === 3) {
                console.log(`  ... (skipping middle months) ...`);
                console.log(`  Month ${wpIteration} (${monthKey}): Balance ₹${(withoutPrepaymentBalance / 100000).toFixed(2)}L - nearing completion`);
                wpDebugCount++;
              }

              // Move to next month
              wpMonth = (wpMonth + 1) % 12;
              if (wpMonth === 0) wpYear++;
            }
            
            console.log(`WITHOUT-PREPAYMENT Loan completed in ${wpIteration} iterations, final balance: ₹${(withoutPrepaymentBalance / 100000).toFixed(2)}L`);

            const withoutPrepaymentTenure = withoutPrepaymentMonths;
            const withoutPrepaymentInterest = withoutPrepaymentInterestTotal;
            
            // Debug: Log without-prepayment completion
            console.log('');
            console.log('WITHOUT-PREPAYMENT SCENARIO COMPLETED:');
            console.log('  • Total Months:', withoutPrepaymentTenure);
            console.log('  • Total Interest:', '₹' + (withoutPrepaymentInterest / 100000).toFixed(2) + 'L');
            console.log('  • Final Balance:', '₹' + (withoutPrepaymentBalance / 100000).toFixed(2) + 'L');
            console.log('  • Iterations:', wpIteration);
            console.log('  • Stopped Reason:', withoutPrepaymentBalance <= 0.01 ? 'Balance cleared' : (wpIteration >= maxIterationsWithoutPrep ? 'Max iterations' : 'EMI insufficient'));
            console.log('');
            
            // Debug logging for savings calculation
            const actualMonthsWithPrepayments = results.length;
            const actualInterestWithPrepayments = totalInterestPaid;
            
            const calculatedMonthsSaved = Math.max(0, withoutPrepaymentTenure - actualMonthsWithPrepayments);
            const calculatedInterestSaved = Math.max(0, withoutPrepaymentInterest - actualInterestWithPrepayments);
            
            // Log raw calculation values
            console.log('RAW CALCULATION VALUES:');
            console.log('  actualMonthsWithPrepayments (results.length):', actualMonthsWithPrepayments);
            console.log('  withoutPrepaymentTenure (withoutPrepaymentMonths):', withoutPrepaymentTenure);
            console.log('  Difference:', withoutPrepaymentTenure - actualMonthsWithPrepayments);
            console.log('  actualInterestWithPrepayments:', actualInterestWithPrepayments);
            console.log('  withoutPrepaymentInterest:', withoutPrepaymentInterest);
            console.log('  Difference:', withoutPrepaymentInterest - actualInterestWithPrepayments);
            console.log('');
            
            // Validate the comparison makes sense
            const comparisonMakesSense = withoutPrepaymentTenure >= actualMonthsWithPrepayments && 
                                        withoutPrepaymentInterest >= actualInterestWithPrepayments;
            
            console.log('');
            console.log('========================================');
            console.log('SAVINGS CALCULATION DEBUG');
            console.log('========================================');
            console.log('');
            console.log('WITH PREPAYMENTS (Your Actual Loan):');
            console.log('  • Total Months:', actualMonthsWithPrepayments);
            console.log('  • Total Interest:', '₹' + (actualInterestWithPrepayments / 100000).toFixed(2) + 'L');
            console.log('  • Total Principal Paid:', '₹' + (totalPrincipalPaid / 100000).toFixed(2) + 'L');
            console.log('  • Total Prepayments Made:', '₹' + (totalPrepaymentsMade / 100000).toFixed(2) + 'L', '(' + prepayments.length + ' payments)');
            console.log('  • Final Balance:', '₹' + (currentBalance / 100000).toFixed(2) + 'L');
            console.log('');
            console.log('WITHOUT PREPAYMENTS (Comparison Scenario):');
            console.log('  • Total Months:', withoutPrepaymentTenure);
            console.log('  • Total Interest:', '₹' + (withoutPrepaymentInterest / 100000).toFixed(2) + 'L');
            console.log('  • Final Balance:', '₹' + (withoutPrepaymentBalance / 100000).toFixed(2) + 'L');
            console.log('');
            console.log('CALCULATED SAVINGS:');
            console.log('  • Months Saved:', calculatedMonthsSaved, 'months');
            console.log('  • Interest Saved:', '₹' + (calculatedInterestSaved / 100000).toFixed(2) + 'L');
            console.log('  • Comparison Valid:', comparisonMakesSense ? 'YES' : 'NO');
            console.log('');
            console.log('========================================');
            console.log('');
            
            // Diagnostic checks
            if (!comparisonMakesSense) {
              console.error('');
              console.error('INVALID COMPARISON DETECTED!');
              console.error('');
              console.error('The without-prepayment scenario should ALWAYS have:');
              console.error('  • MORE months than with-prepayment scenario');
              console.error('  • MORE interest than with-prepayment scenario');
              console.error('');
              console.error('Current situation:');
              console.error('  • Without months (' + withoutPrepaymentTenure + ') >= With months (' + actualMonthsWithPrepayments + '):', withoutPrepaymentTenure >= actualMonthsWithPrepayments ? 'YES' : 'NO');
              console.error('  • Without interest (' + (withoutPrepaymentInterest / 100000).toFixed(2) + 'L) >= With interest (' + (actualInterestWithPrepayments / 100000).toFixed(2) + 'L):', withoutPrepaymentInterest >= actualInterestWithPrepayments ? 'YES' : 'NO');
              console.error('');
            } else if (calculatedMonthsSaved === 0 && calculatedInterestSaved === 0 && totalPrepaymentsMade > 0) {
              console.error('');
              console.error('ERROR: PREPAYMENTS MADE BUT SAVINGS = 0!');
              console.error('');
              console.error('Diagnosis:');
              console.error('  • Prepayments Applied: ₹' + (totalPrepaymentsMade / 100000).toFixed(2) + 'L (' + prepayments.length + ' payments)');
              console.error('  • With Prepayments Months:', actualMonthsWithPrepayments);
              console.error('  • Without Prepayments Months:', withoutPrepaymentTenure);
              console.error('  • Difference:', withoutPrepaymentTenure - actualMonthsWithPrepayments, 'months');
              console.error('  • With Prepayments Interest: ₹' + (actualInterestWithPrepayments / 100000).toFixed(2) + 'L');
              console.error('  • Without Prepayments Interest: ₹' + (withoutPrepaymentInterest / 100000).toFixed(2) + 'L');
              console.error('  • Difference: ₹' + ((withoutPrepaymentInterest - actualInterestWithPrepayments) / 100000).toFixed(2) + 'L');
              console.error('');
              if (actualMonthsWithPrepayments === withoutPrepaymentTenure) {
                console.error('ERROR: BOTH SCENARIOS HAVE IDENTICAL TENURE!');
                console.error('   This should not happen when prepayments are applied.');
              }
              if (actualInterestWithPrepayments === withoutPrepaymentInterest) {
                console.error('ERROR: BOTH SCENARIOS HAVE IDENTICAL INTEREST!');
                console.error('   This should not happen when prepayments are applied.');
              }
              console.error('');
            } else if (totalPrepaymentsMade === 0 && prepayments.length > 0) {
              console.warn('');
              console.warn('WARNING: PREPAYMENTS ENTERED BUT NOT APPLIED!');
              console.warn('');
              console.warn('  • Prepayments Entered:', prepayments.length);
              console.warn('  • Prepayments Actually Applied: 0');
              console.warn('');
              console.warn('Possible Reasons:');
              console.warn('  1. Prepayment months don\'t match loan schedule months');
              console.warn('  2. Prepayment dates are outside the loan period');
              console.warn('  3. Month/year format mismatch');
              console.warn('');
              console.warn('Check "Prepayment Map Keys" above and compare with loan schedule months.');
              console.warn('');
            } else if (calculatedMonthsSaved > 0 || calculatedInterestSaved > 0) {
              console.log('SAVINGS CALCULATION SUCCESSFUL!');
              console.log('  • You are saving', calculatedMonthsSaved, 'months');
              console.log('  • You are saving ₹' + (calculatedInterestSaved / 100000).toFixed(2) + 'L in interest');
              console.log('');
            }
            
            // Calculate minimum EMI required (using starting ROI)

            // Calculate remaining months from current date
            const currentDate = new Date();
            const startDate = new Date(loanData.startYear, months.indexOf(loanData.startMonth), 1);
            const monthsElapsed = Math.max(0, (currentDate.getFullYear() - startDate.getFullYear()) * 12 + (currentDate.getMonth() - startDate.getMonth()));
            const remainingMonths = Math.max(0, results.length - monthsElapsed);

            return {
              schedule: results,
              summary: {
                totalMonths: results.length,
                remainingMonths: remainingMonths,
                lastEMIMonth: results[results.length - 1]?.month || 'N/A',
                totalInterestPaid,
                totalPrincipalPaid,
                totalPrepaymentsMade,
                totalDisbursementsMade,
                totalAmountPaid: totalInterestPaid + totalPrincipalPaid,
                withoutPrepaymentMonths: withoutPrepaymentTenure,
                theoreticalTenure: theoreticalTenure,
                withoutPrepaymentInterest,
                monthsSaved: Math.max(0, withoutPrepaymentTenure - results.length),
                interestSaved: Math.max(0, withoutPrepaymentInterest - totalInterestPaid),
                isEMISufficient,
                minEMIRequired
              }
            };
          }, [loanData, disbursements, prepayments, roiPeriods, emiPeriods]);

          const motivationStats = useMemo(() => {
            if (projectionData.schedule.length === 0) return null;
            
            const crossoverMonth = projectionData.schedule.find(row => row.principalVsInterestRatio >= 1);
            const currentRatio = projectionData.schedule[0]?.principalVsInterestRatio || 0;
            
            return {
              crossoverMonth,
              currentRatio,
              milestones: [
                {
                  achieved: currentRatio >= 0.5,
                  title: "EMI Principal = 50% of Interest",
                  description: "Your EMI principal is half of interest"
                },
                {
                  achieved: currentRatio >= 1,
                  title: "EMI Principal = Interest (1:1)",
                  description: "EMI principal matches interest!"
                },
                {
                  achieved: currentRatio >= 2,
                  title: "EMI Principal = 2x Interest",
                  description: "EMI principal is double the interest!"
                },
                {
                  achieved: currentRatio >= 3,
                  title: "EMI Principal = 3x Interest",
                  description: "Triple power! Crushing the loan!"
                }
              ]
            };
          }, [projectionData]);

          const handleInputChange = (field, value) => {
            let parsedValue = parseFloat(value);
            
            // Validation
            if (isNaN(parsedValue) || parsedValue < 0) {
              parsedValue = 0;
            }
            
            setLoanData(prev => ({
              ...prev,
              [field]: parsedValue
            }));
          };

          const handleStartDateChange = (field, value) => {
            setLoanData(prev => ({
              ...prev,
              [field]: value
            }));
          };

          const handleDateChange = (field, value) => {
            // value is YYYY-MM-DD (or '')
            setLoanData(prev => ({
              ...prev,
              [field]: value
            }));
          };

          const addDisbursement = () => {
            const amountValue = parseFloat(newDisbursement.amount);
            const dateValue = newDisbursement.date;
            if (amountValue > 0 && dateValue) {
              const updated = [...disbursements, { date: dateValue, amount: amountValue }];
              // Sort disbursements by date
              updated.sort((a, b) => new Date(a.date) - new Date(b.date));
              setDisbursements(updated);
              setNewDisbursement({ date: '', amount: '' });

              // Update loan data with initial disbursed amount (only disbursements up to start date)
              const startDate = new Date(loanData.startYear, months.indexOf(loanData.startMonth), 1);
              const initialDisbursements = updated.filter(d => new Date(d.date) <= startDate);
              const totalInitialDisbursed = initialDisbursements.reduce((sum, d) => sum + d.amount, 0);
              setLoanData(prev => ({ ...prev, startingBalance: totalInitialDisbursed }));

              // Keep startMonth/startYear in sync with first disbursement date
              if (updated.length > 0) {
                const firstDisbursement = updated[0];
                const d = new Date(firstDisbursement.date + 'T00:00:00');
                if (!isNaN(d.getTime())) {
                  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                  setLoanData(prev => ({ ...prev, startMonth: months[d.getMonth()], startYear: d.getFullYear() }));
                }
              }
            }
          };

          const removeDisbursement = (index) => {
            const updated = disbursements.filter((_, i) => i !== index);
            setDisbursements(updated);

            // Update loan data with initial disbursed amount (only disbursements up to start date)
            const startDate = new Date(loanData.startYear, months.indexOf(loanData.startMonth), 1);
            const initialDisbursements = updated.filter(d => new Date(d.date) <= startDate);
            const totalInitialDisbursed = initialDisbursements.reduce((sum, d) => sum + d.amount, 0);
            setLoanData(prev => ({ ...prev, startingBalance: totalInitialDisbursed }));
          };

          const clearAllDisbursements = () => {
            setDisbursements([]);
            setLoanData(prev => ({ ...prev, startingBalance: 0 }));
          };

          const addRoiPeriod = () => {
            const roiValue = parseFloat(newRoiPeriod.roi);
            if (roiValue > 0) {
              const updated = [...roiPeriods, { month: newRoiPeriod.month, year: newRoiPeriod.year, roi: roiValue }];
              // Sort ROI periods by date
              updated.sort((a, b) => {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                if (a.year !== b.year) return a.year - b.year;
                return months.indexOf(a.month) - months.indexOf(b.month);
              });
              setRoiPeriods(updated);
              
              // Auto-increment month and clear ROI value
              const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              const currentMonthIdx = months.indexOf(newRoiPeriod.month);
              const nextMonthIdx = (currentMonthIdx + 1) % 12;
              const nextYear = nextMonthIdx === 0 ? newRoiPeriod.year + 1 : newRoiPeriod.year;
              setNewRoiPeriod({
                month: months[nextMonthIdx],
                year: nextYear,
                roi: ''
              });
            }
          };

          const removeRoiPeriod = (index) => {
              setRoiPeriods(roiPeriods.filter((_, i) => i !== index));
          };

          const clearAllRoiPeriods = () => {
            if (confirm('Clear all ROI periods?')) {
              setRoiPeriods([]);
            }
          };

          const addEmiPeriod = () => {
            const emiValue = parseFloat(newEmiPeriod.emi);
            if (emiValue > 0) {
              const updated = [...emiPeriods, { month: newEmiPeriod.month, year: newEmiPeriod.year, emi: emiValue }];
              // Sort EMI periods by date
              updated.sort((a, b) => {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                if (a.year !== b.year) return a.year - b.year;
                return months.indexOf(a.month) - months.indexOf(b.month);
              });
              setEmiPeriods(updated);
              
              // Auto-increment month and clear EMI value
              const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              const currentMonthIdx = months.indexOf(newEmiPeriod.month);
              const nextMonthIdx = (currentMonthIdx + 1) % 12;
              const nextYear = nextMonthIdx === 0 ? newEmiPeriod.year + 1 : newEmiPeriod.year;
              setNewEmiPeriod({
                month: months[nextMonthIdx],
                year: nextYear,
                emi: ''
              });
            }
          };

          const removeEmiPeriod = (index) => {
              setEmiPeriods(emiPeriods.filter((_, i) => i !== index));
          };

          const clearAllEmiPeriods = () => {
            if (confirm('Clear all EMI periods?')) {
              setEmiPeriods([]);
            }
          };

          const resetAllData = () => {
            if (confirm('WARNING: This will reset the CURRENT PROFILE only!\n\nAre you sure you want to reset all data for profile "' + currentProfile + '"?\n\nTip: To delete a profile completely, use the X button next to the profile name.')) {
              setLoanData({
                startingBalance: 0,
                startMonth: 'Jan',
                startYear: new Date().getFullYear(),
                disbursementDate: '',
                emiStartDate: '',
                dayCountBasis: 'ACT_365'
              });
              setRoiPeriods([]);
              setEmiPeriods([]);
              setPrepayments([]);
            }
          };

          const exportAllProfiles = () => {
            const dataStr = JSON.stringify({
              profiles,
              currentProfile,
              exportDate: new Date().toISOString(),
              version: '1.0'
            }, null, 2);
            
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loan-calculator-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
          };

          const importProfiles = (event) => {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                try {
                  const data = JSON.parse(e.target.result);
                  if (data.profiles) {
                    if (confirm('Import profiles? This will merge with existing profiles (duplicates will be overwritten).')) {
                      const mergedProfiles = { ...profiles, ...data.profiles };
                      setProfiles(mergedProfiles);
                      localStorage.setItem('loanProfiles', JSON.stringify(mergedProfiles));
                      alert('✅ Profiles imported successfully!');
                    }
                  } else {
                    alert('❌ Invalid backup file format!');
                  }
                } catch (error) {
                  alert('❌ Error reading backup file: ' + error.message);
                }
              };
              reader.readAsText(file);
            }
          };

          const createNewProfile = () => {
            if (newProfileName && !profiles[newProfileName]) {
              const newProfile = {
                loanData: { ...normalizeLoanData(loanData) },
                roiPeriods: [...roiPeriods],
                emiPeriods: [...emiPeriods],
                prepayments: [...prepayments]
              };
              setProfiles({ ...profiles, [newProfileName]: newProfile });
              setCurrentProfile(newProfileName);
              setShowProfileModal(false);
              setNewProfileName('');
            } else {
              alert('Please enter a unique profile name!');
            }
          };

          const switchProfile = (profileName) => {
            if (profiles[profileName]) {
              setCurrentProfile(profileName);
              const profile = profiles[profileName];
              setLoanData(normalizeLoanData(profile.loanData));
              setRoiPeriods(profile.roiPeriods);
              setEmiPeriods(profile.emiPeriods);
              setPrepayments(profile.prepayments);
            }
          };

          const deleteProfile = (profileName) => {
            if (profileName === 'Default') {
              alert('Cannot delete the Default profile!');
              return;
            }
            if (confirm(`Delete profile "${profileName}"?`)) {
              const updatedProfiles = { ...profiles };
              delete updatedProfiles[profileName];
              setProfiles(updatedProfiles);
              if (currentProfile === profileName) {
                switchProfile('Default');
              }
            }
          };

          const addPrepayment = () => {
            const amountValue = parseFloat(newPrepayment.amount);
            if (amountValue > 0) {
              const updated = [...prepayments, { month: newPrepayment.month, year: newPrepayment.year, amount: amountValue }];
              // Sort prepayments by date
              updated.sort((a, b) => {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                if (a.year !== b.year) return a.year - b.year;
                return months.indexOf(a.month) - months.indexOf(b.month);
              });
              setPrepayments(updated);
              
              // Auto-increment month and clear amount
              const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
              const currentMonthIdx = months.indexOf(newPrepayment.month);
              const nextMonthIdx = (currentMonthIdx + 1) % 12;
              const nextYear = nextMonthIdx === 0 ? newPrepayment.year + 1 : newPrepayment.year;
              setNewPrepayment({
                month: months[nextMonthIdx],
                year: nextYear,
                amount: ''
              });
            }
          };

          const removePrepayment = (index) => {
            setPrepayments(prepayments.filter((_, i) => i !== index));
          };

          const clearAllPrepayments = () => {
            if (confirm('Are you sure you want to remove all prepayments?')) {
              setPrepayments([]);
            }
          };

          const exportToCSV = () => {
            const headers = [
              'Month',
              'ROI (%)',
              'EMI (₹)',
              'Opening Balance (₹)', 
              'Interest (₹)', 
              'EMI Principal (₹)', 
              'Prepayment (₹)', 
              'Total Principal (₹)', 
              'Closing Balance (₹)', 
              'Months Saved by Prepayment', 
              'EMI Principal/Interest Ratio',
              'Cumulative Interest (₹)',
              'Cumulative Principal (₹)'
            ];
            
            const rows = projectionData.schedule.map(row => [
              row.month,
              row.roi,
              row.emi,
              row.openingBalance,
              row.interest,
              row.emiPrincipal,
              row.prepayment,
              row.principalPaidThisMonth,
              row.closingBalance,
              row.monthsReduced,
              row.principalVsInterestRatio.toFixed(2),
              row.totalInterestPaid,
              row.totalPrincipalPaid
            ]);
            
            // Add summary at the end
            rows.push([]);
            rows.push(['Summary']);
            rows.push(['Total Months', projectionData.summary.totalMonths]);
            rows.push(['Total Interest Paid', projectionData.summary.totalInterestPaid]);
            rows.push(['Total Principal Paid', projectionData.summary.totalPrincipalPaid]);
            rows.push(['Total Prepayments', projectionData.summary.totalPrepaymentsMade]);
            rows.push(['Months Saved', projectionData.summary.monthsSaved]);
            rows.push(['Interest Saved', projectionData.summary.interestSaved]);
            
            // Add ROI period breakdown
            rows.push([]);
            rows.push(['ROI Period Breakdown']);
            const roiMonthCount = {};
            projectionData.schedule.forEach(row => {
              roiMonthCount[row.roi] = (roiMonthCount[row.roi] || 0) + 1;
            });
            Object.entries(roiMonthCount).forEach(([roi, months]) => {
              rows.push([`${roi}% ROI`, `${months} months`]);
            });
            
            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loan_projection_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 md:p-8">

              <div className="max-w-7xl mx-auto">
                
                <div className="bg-gradient-to-r from-indigo-600 via-purple-600 to-indigo-600 rounded-2xl shadow-2xl p-6 md:p-8 mb-6">
                  <div className="flex justify-between items-start mb-3">
                    <div className="flex items-center gap-4">
                      <div className="bg-white bg-opacity-20 backdrop-blur rounded-xl p-2">
                        <LoanWiseLogo size="56" />
                      </div>
                      <div>
                        <h1 className="text-3xl md:text-4xl font-bold text-white flex items-center gap-2">
                          LoanWise
                        </h1>
                        <p className="text-base md:text-lg text-yellow-300 font-semibold mt-1">Make Smarter Loan Decisions</p>
                        <p className="text-xs text-purple-200 mt-1">Free • No Ads • 100% Private</p>
                      </div>
                    </div>
                    <button
                      onClick={resetAllData}
                      className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg"
                      title="Reset all data"
                    >
                      Reset
                    </button>
                  </div>
                  <div className="bg-white bg-opacity-10 backdrop-blur rounded-lg p-3 mt-3">
                    <p className="text-purple-100 text-sm md:text-base">
                      Plan your EMI • Track prepayments • Variable ROI/EMI support • Save thousands in interest
                    </p>
                  </div>
                </div>

                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-xl shadow-lg p-5 mb-6">
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <h3 className="text-xl font-bold text-white">👤 Profiles</h3>
                      <p className="text-xs text-indigo-200 mt-0.5">Active: <strong className="text-yellow-300">{currentProfile}</strong></p>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <button
                        onClick={() => setShowRecoveryModal(true)}
                        className="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg font-semibold text-xs transition-all shadow-md hover:shadow-lg"
                        title="Data recovery"
                      >
                        🔧
                      </button>
                      <button
                        onClick={exportAllProfiles}
                        className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1.5 rounded-lg font-semibold text-xs transition-all shadow-md hover:shadow-lg"
                        title="Backup"
                      >
                        Backup
                      </button>
                      <label className="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded-lg font-semibold text-xs transition-all shadow-md hover:shadow-lg cursor-pointer">
                        Restore
                        <input
                          type="file"
                          accept=".json"
                          onChange={importProfiles}
                          className="hidden"
                        />
                      </label>
                      <button
                        onClick={() => setShowProfileModal(true)}
                        className="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg font-semibold text-xs transition-all shadow-md hover:shadow-lg"
                      >
                        + New
                      </button>
                    </div>
                  </div>
                  
                  <div className="flex gap-2 flex-wrap">
                    {Object.keys(profiles).map(profileName => (
                      <div key={profileName} className="flex items-center gap-1">
                        <button
                          onClick={() => switchProfile(profileName)}
                          className={`px-3 py-2 rounded-lg font-semibold text-sm transition-all ${
                            currentProfile === profileName
                              ? 'bg-yellow-400 text-gray-900 shadow-lg'
                              : 'bg-white bg-opacity-90 text-gray-800 hover:bg-opacity-100 shadow-md'
                          }`}
                        >
                          {profileName}
                        </button>
                        {profileName !== 'Default' && (
                          <button
                            onClick={() => deleteProfile(profileName)}
                            className="text-red-300 hover:text-red-100 font-bold text-sm w-6 h-6 flex items-center justify-center hover:bg-red-500 hover:bg-opacity-30 rounded transition-all"
                            title="Delete"
                          >
                            ✕
                          </button>
                        )}
                      </div>
                    ))}
                  </div>

                  {showProfileModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                      <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                        <h3 className="text-xl font-bold mb-4">Create New Profile</h3>
                        <input
                          type="text"
                          value={newProfileName}
                          onChange={(e) => setNewProfileName(e.target.value)}
                          placeholder="Profile name"
                          className="w-full px-4 py-2 border-2 border-gray-300 rounded-lg mb-4"
                          onKeyPress={(e) => e.key === 'Enter' && createNewProfile()}
                        />
                        <div className="flex gap-2">
                          <button
                            onClick={createNewProfile}
                            className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold"
                          >
                            Create
                          </button>
                          <button
                            onClick={() => {
                              setShowProfileModal(false);
                              setNewProfileName('');
                            }}
                            className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold"
                          >
                            Cancel
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {showShareModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                      <div className="bg-white rounded-xl p-6 max-w-md w-full mx-4">
                        <div className="flex justify-between items-center mb-4">
                          <h3 className="text-2xl font-bold text-gray-800">Share LoanWise</h3>
                          <button
                            onClick={() => setShowShareModal(false)}
                            className="text-gray-500 hover:text-gray-700 text-3xl font-bold leading-none"
                          >
                            ×
                          </button>
                        </div>
                        <p className="text-gray-600 mb-6">Choose how you'd like to share LoanWise with others:</p>
                        
                        <div className="space-y-3">
                          {/* WhatsApp */}
                          <button
                            onClick={() => {
                              const shareText = encodeURIComponent('Check out LoanWise - a FREE loan calculator that helped me plan my EMI and save thousands in interest!');
                              const shareUrl = encodeURIComponent('https://loanwisely.netlify.app/');
                              window.open(`https://wa.me/?text=${shareText}%20${shareUrl}`, '_blank');
                              setShowShareModal(false);
                            }}
                            className="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-3 shadow-md hover:shadow-lg"
                          >
                            <span className="text-2xl">💬</span>
                            <span>Share on WhatsApp</span>
                          </button>

                          {/* X (Twitter) */}
                          <button
                            onClick={() => {
                              const shareText = encodeURIComponent('Check out LoanWise - a FREE loan calculator that helped me plan my EMI and save thousands in interest!');
                              const shareUrl = encodeURIComponent('https://loanwisely.netlify.app/');
                              window.open(`https://twitter.com/intent/tweet?text=${shareText}&url=${shareUrl}`, '_blank');
                              setShowShareModal(false);
                            }}
                            className="w-full bg-black hover:bg-gray-800 text-white px-6 py-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-3 shadow-md hover:shadow-lg"
                          >
                            <span className="text-2xl">𝕏</span>
                            <span>Share on X (Twitter)</span>
                          </button>

                          {/* LinkedIn */}
                          <button
                            onClick={() => {
                              const shareUrl = encodeURIComponent('https://loanwisely.netlify.app/');
                              window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${shareUrl}`, '_blank');
                              setShowShareModal(false);
                            }}
                            className="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-3 shadow-md hover:shadow-lg"
                          >
                            <span className="text-2xl">💼</span>
                            <span>Share on LinkedIn</span>
                          </button>

                          {/* Email */}
                          <button
                            onClick={() => {
                              const subject = encodeURIComponent('Check out LoanWise - Smart Loan Calculator');
                              const body = encodeURIComponent('Hi!\n\nI wanted to share this amazing FREE loan calculator with you - LoanWise! It helps plan EMI payments and can save thousands in interest.\n\nCheck it out here: https://loanwisely.netlify.app/\n\nIt\'s completely free and your data stays private in your browser!');
                              window.location.href = `mailto:?subject=${subject}&body=${body}`;
                              setShowShareModal(false);
                            }}
                            className="w-full bg-red-500 hover:bg-red-600 text-white px-6 py-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-3 shadow-md hover:shadow-lg"
                          >
                            <span className="text-2xl">Email</span>
                            <span>Share via Email</span>
                          </button>

                          {/* Copy Link */}
                          <button
                            onClick={() => {
                              navigator.clipboard.writeText('https://loanwisely.netlify.app/');
                              alert('✅ Link copied to clipboard! Share it anywhere you like.');
                              setShowShareModal(false);
                            }}
                            className="w-full bg-gray-600 hover:bg-gray-700 text-white px-6 py-4 rounded-lg font-semibold transition-all flex items-center justify-center gap-3 shadow-md hover:shadow-lg"
                          >
                            <span className="text-2xl">🔗</span>
                            <span>Copy Link</span>
                          </button>
                        </div>

                        <button
                          onClick={() => setShowShareModal(false)}
                          className="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-semibold transition-all"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  )}

                  {showDebugModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                      <div className="bg-white rounded-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                          <h3 className="text-2xl font-bold">Calculation Details - Profile: {currentProfile}</h3>
                          <button
                            onClick={() => setShowDebugModal(false)}
                            className="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                          >
                            ×
                          </button>
                        </div>
                        
                        <div className="space-y-4">
                          {/* Loan Details */}
                          <div className="bg-purple-50 border-2 border-purple-200 rounded-lg p-4">
                            <h4 className="font-bold text-purple-800 mb-2">Basic Loan Details</h4>
                            <div className="grid grid-cols-2 gap-2 text-sm mb-3">
                              <div><span className="font-semibold">Starting Balance:</span> ₹{loanData.startingBalance.toLocaleString('en-IN')}</div>
                              <div><span className="font-semibold">Start Date:</span> {loanData.startMonth} {loanData.startYear}</div>
                            </div>
                            {disbursements.length > 0 && (
                              <div className="text-sm mt-2">
                                <div className="font-semibold text-purple-700 mb-2">Disbursements Breakdown:</div>
                                <div className="space-y-1 max-h-40 overflow-y-auto">
                                  {disbursements.map((disb, idx) => (
                                    <div key={idx} className="bg-white p-1.5 rounded text-xs">
                                      <span className="font-semibold">#{idx + 1}:</span> ₹{disb.amount.toLocaleString('en-IN')} on {disb.date}
                                    </div>
                                  ))}
                                  <div className="bg-purple-100 p-1.5 rounded font-bold text-purple-800">
                                    Total Disbursed: ₹{disbursements.reduce((sum, d) => sum + d.amount, 0).toLocaleString('en-IN')}
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>

                          {/* ROI Periods */}
                          <div className="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                            <h4 className="font-bold text-yellow-800 mb-2">ROI Periods ({roiPeriods.length})</h4>
                            <div className="space-y-1 text-sm">
                              {roiPeriods.map((roi, idx) => (
                                <div key={idx} className="bg-white p-2 rounded">
                                  <span className="font-semibold">Period {idx + 1}:</span> {roi.roi}% from {roi.month} {roi.year}
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* EMI Periods */}
                          <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                            <h4 className="font-bold text-green-800 mb-2">EMI Periods ({emiPeriods.length})</h4>
                            <div className="space-y-1 text-sm">
                              {emiPeriods.map((emi, idx) => (
                                <div key={idx} className="bg-white p-2 rounded">
                                  <span className="font-semibold">Period {idx + 1}:</span> ₹{emi.emi.toLocaleString('en-IN')} from {emi.month} {emi.year}
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Disbursements */}
                          <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                            <h4 className="font-bold text-green-800 mb-2">Disbursements ({disbursements.length})</h4>
                            <div className="space-y-1 text-sm">
                              {disbursements.map((disb, idx) => {
                                const date = new Date(disb.date);
                                const month = date.toLocaleDateString('en-IN', { month: 'short' });
                                const year = date.getFullYear();
                                return (
                                  <div key={idx} className="bg-white p-2 rounded flex justify-between items-center">
                                    <span className="text-green-700 font-bold">+ ₹{disb.amount.toLocaleString('en-IN')}</span>
                                    <span className="text-sm text-gray-600">from {month} {year}</span>
                                  </div>
                                );
                              })}
                              {disbursements.length > 0 && (
                                <div className="bg-green-100 p-2 rounded font-bold">
                                  Total Disbursed: ₹{disbursements.reduce((sum, d) => sum + d.amount, 0).toLocaleString('en-IN')}
                                </div>
                              )}
                            </div>
                          </div>

                          {/* Prepayments */}
                          <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                            <h4 className="font-bold text-blue-800 mb-2">Prepayments ({prepayments.length})</h4>
                            {prepayments.length > 0 ? (
                              <div className="space-y-1 text-sm max-h-60 overflow-y-auto">
                                {prepayments.map((prep, idx) => (
                                  <div key={idx} className="bg-white p-2 rounded">
                                    <span className="font-semibold">#{idx + 1}:</span> ₹{prep.amount.toLocaleString('en-IN')} on {prep.month} {prep.year}
                                  </div>
                                ))}
                                <div className="bg-green-100 p-2 rounded font-bold">
                                  Total Prepayments: ₹{prepayments.reduce((sum, p) => sum + p.amount, 0).toLocaleString('en-IN')}
                                </div>
                              </div>
                            ) : (
                              <p className="text-sm text-gray-600">No prepayments scheduled</p>
                            )}
                          </div>

                          {/* Calculation Results */}
                          <div className="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-4">
                            <h4 className="font-bold text-indigo-800 mb-2">Calculation Results</h4>
                            <div className="space-y-2 text-sm">
                              <div className="bg-white p-2 rounded">
                                <span className="font-semibold">Remaining Months:</span> {projectionData.summary.remainingMonths} months ({Math.floor(projectionData.summary.remainingMonths / 12)} years {projectionData.summary.remainingMonths % 12} months)
                              </div>
                              <div className="bg-white p-2 rounded">
                                <span className="font-semibold">Total Tenure:</span> {projectionData.schedule.length} months ({Math.floor(projectionData.schedule.length / 12)} years {projectionData.schedule.length % 12} months)
                              </div>
                              <div className="bg-white p-2 rounded">
                                <span className="font-semibold">Bank EMI Formula Tenure:</span> {projectionData.summary.theoreticalTenure} months ({Math.floor(projectionData.summary.theoreticalTenure / 12)} years {projectionData.summary.theoreticalTenure % 12} months)
                              </div>
                              <div className="bg-white p-2 rounded">
                                <span className="font-semibold">Theoretical Tenure (EMI Formula):</span> {projectionData.summary.theoreticalTenure} months ({Math.floor(projectionData.summary.theoreticalTenure / 12)} years {projectionData.summary.theoreticalTenure % 12} months)
                              </div>
                              <div className="bg-white p-2 rounded">
                                <span className="font-semibold">Total Interest Paid:</span> ₹{projectionData.summary.totalInterestPaid.toLocaleString('en-IN')}
                              </div>
                              <div className="bg-white p-2 rounded">
                                <span className="font-semibold">Total Principal Paid:</span> ₹{projectionData.summary.totalPrincipalPaid.toLocaleString('en-IN')}
                              </div>
                              <div className="bg-white p-2 rounded">
                                <span className="font-semibold">Total Amount Paid:</span> ₹{projectionData.summary.totalAmountPaid.toLocaleString('en-IN')}
                              </div>
                            </div>
                          </div>

                          {/* Export Raw Data */}
                          <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                            <h4 className="font-bold text-gray-800 mb-2">Export Raw Data</h4>
                            <p className="text-sm text-gray-600 mb-3">Copy this data to share or analyze:</p>
                            <textarea
                              className="w-full p-3 border-2 border-gray-300 rounded font-mono text-xs"
                              rows="8"
                              readOnly
                              value={JSON.stringify({
                                profile: currentProfile,
                                loanData,
                                roiPeriods,
                                emiPeriods,
                                prepayments,
                                disbursements,
                                calculatedMonths: projectionData.schedule.length,
                                remainingMonths: projectionData.summary.remainingMonths
                              }, null, 2)}
                              onClick={(e) => e.target.select()}
                            />
                          </div>
                        </div>

                        <button
                          onClick={() => setShowDebugModal(false)}
                          className="mt-4 w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  )}

                  {showRecoveryModal && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                      <div className="bg-white rounded-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                          <h3 className="text-2xl font-bold text-red-600">🔧 Data Recovery Tool</h3>
                          <button
                            onClick={() => setShowRecoveryModal(false)}
                            className="text-gray-500 hover:text-gray-700 text-2xl font-bold"
                          >
                            ×
                          </button>
                        </div>
                        
                        <div className="space-y-4">
                          {/* Current localStorage Data */}
                          <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                            <h4 className="font-bold text-blue-800 mb-2">Current Browser Storage (localStorage)</h4>
                            <p className="text-sm text-gray-700 mb-3">This is what's currently saved in your browser:</p>
                            <textarea
                              className="w-full p-3 border-2 border-gray-300 rounded font-mono text-xs"
                              rows="12"
                              readOnly
                              value={JSON.stringify({
                                loanProfiles: JSON.parse(localStorage.getItem('loanProfiles') || '{}'),
                                currentProfile: localStorage.getItem('currentProfile')
                              }, null, 2)}
                              onClick={(e) => e.target.select()}
                            />
                            <p className="text-xs text-gray-600 mt-2">You can copy this data and save it as a backup file (.json)</p>
                          </div>

                          {/* Recovery Instructions */}
                          <div className="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                            <h4 className="font-bold text-yellow-800 mb-2">Data Recovery Options</h4>
                            <div className="text-sm text-gray-700 space-y-2">
                              <p><strong>If you just lost data:</strong></p>
                              <ol className="list-decimal ml-5 space-y-1">
                                <li><strong>Check if you have a backup file:</strong> If you clicked "Backup" before, restore it using "Restore" button</li>
                                <li><strong>Browser history:</strong> Try pressing Ctrl+Shift+H (or Cmd+Shift+H on Mac) and check if you have the page open in another tab</li>
                                <li><strong>Don't close the browser:</strong> If you have multiple windows/tabs open, one might still have the old data</li>
                                <li><strong>Check browser console:</strong> Press F12, go to "Application" tab → "Local Storage" → check if old data exists</li>
                              </ol>
                              
                              <p className="mt-3"><strong>Prevention for future:</strong></p>
                              <ul className="list-disc ml-5 space-y-1">
                                <li>Click "Backup" button regularly to download a backup file</li>
                                <li>Keep backup files in a safe location (Google Drive, Dropbox, etc.)</li>
                                <li>Use "Restore" to recover from backup files</li>
                              </ul>
                            </div>
                          </div>

                          {/* Quick Actions */}
                          <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                            <h4 className="font-bold text-green-800 mb-2">Quick Actions</h4>
                            <div className="space-y-2">
                              <button
                                onClick={() => {
                                  const data = localStorage.getItem('loanProfiles');
                                  if (data) {
                                    navigator.clipboard.writeText(data);
                                    alert('Current data copied to clipboard! Save it in a text file as backup.');
                                  }
                                }}
                                className="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold"
                              >
                                Copy Current Data to Clipboard
                              </button>
                              
                              <button
                                onClick={() => {
                                  exportAllProfiles();
                                    alert('Backup file downloaded! Keep it safe for future recovery.');
                                }}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold"
                              >
                                Download Backup Now
                              </button>
                            </div>
                          </div>

                          {/* Manual Recovery */}
                          <div className="bg-red-50 border-2 border-red-200 rounded-lg p-4">
                            <h4 className="font-bold text-red-800 mb-2">Manual Recovery (Advanced)</h4>
                            <p className="text-sm text-gray-700 mb-3">If you have backup data from another source, paste it here:</p>
                            <textarea
                              id="manualRecoveryData"
                              className="w-full p-3 border-2 border-gray-300 rounded font-mono text-xs"
                              rows="6"
                              placeholder='Paste your backup JSON data here... e.g., {"Default": {...}, "MyProfile": {...}}'
                            />
                            <button
                              onClick={() => {
                                try {
                                  const data = document.getElementById('manualRecoveryData').value;
                                  const parsed = JSON.parse(data);
                                  if (confirm('This will restore the profiles from the pasted data. Continue?')) {
                                    localStorage.setItem('loanProfiles', JSON.stringify(parsed));
                                    window.location.reload();
                                  }
                                } catch (error) {
                                    alert('Invalid JSON data: ' + error.message);
                                }
                              }}
                              className="mt-2 w-full bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold"
                            >
                              Restore from Pasted Data
                            </button>
                          </div>
                        </div>

                        <button
                          onClick={() => setShowRecoveryModal(false)}
                          className="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  )}
                </div>

                {/* Quick Summary - Compact with Better Colors */}
                <div className="bg-gradient-to-br from-gray-800 to-gray-900 rounded-xl shadow-lg p-4 mb-6">
                  <div className="flex items-center justify-between mb-3">
                    <h3 className="text-base font-bold text-white">Summary</h3>
                    {projectionData?.schedule?.length > 0 && (
                      <span className="text-xs text-gray-300 font-semibold">
                        Duration: {Math.floor(projectionData.schedule.length / 12)}y {projectionData.schedule.length % 12}m
                      </span>
                    )}
                  </div>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                    {/* Principal */}
                    <div className="bg-blue-500 bg-opacity-90 rounded-lg p-3 text-white">
                      <p className="text-xs opacity-90 mb-1">Principal</p>
                      <p className="text-lg font-bold">₹{(((disbursements.length > 0 ? (projectionData?.summary?.totalDisbursementsMade || 0) : (loanData?.startingBalance || 0))) / 100000).toFixed(2)}L</p>
                    </div>

                    {/* Interest */}
                    <div className="bg-orange-500 bg-opacity-90 rounded-lg p-3 text-white">
                      <p className="text-xs opacity-90 mb-1">Interest</p>
                      <p className="text-lg font-bold">₹{((projectionData?.summary?.totalInterestPaid || 0) / 100000).toFixed(2)}L</p>
                    </div>

                    {/* Total Payable */}
                    <div className="bg-indigo-600 bg-opacity-90 rounded-lg p-3 text-white">
                      <p className="text-xs opacity-90 mb-1">Total</p>
                      <p className="text-lg font-bold">₹{((projectionData?.summary?.totalAmountPaid || 0) / 100000).toFixed(2)}L</p>
                    </div>

                    {/* Saved */}
                    <div className="bg-green-600 bg-opacity-90 rounded-lg p-3 text-white">
                      <p className="text-xs opacity-90 mb-1">Saved</p>
                      <p className="text-lg font-bold">₹{((projectionData?.summary?.interestSaved || 0) / 100000).toFixed(2)}L</p>
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-6">
                  <h2 className="text-xl font-bold text-gray-800 mb-4">Loan Inputs</h2>
                  
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {/* Left Column - Basic + ROI */}
                    <div className="space-y-4">
                      {/* Basic Info */}
                      <div className="bg-purple-50 rounded-lg p-3 border border-purple-200">
                        <h3 className="text-sm font-bold text-purple-700 mb-2">Loan Details</h3>
                        <div className="grid grid-cols-3 gap-2">
                      <input
                        type="number"
                            value={loanData.startingBalance || ''}
                        onChange={(e) => handleInputChange('startingBalance', e.target.value)}
                            className="col-span-3 px-3 py-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:ring-1 focus:ring-purple-200 outline-none"
                            placeholder="Loan Amount (₹)"
                        min="0"
                      />
                      <div className="col-span-3">
                        <div className="flex items-center gap-2 mb-1">
                          <span className="text-xs font-medium text-gray-700">Disbursements</span>
                          {disbursements.length > 0 && (
                            <button onClick={clearAllDisbursements} className="text-xs text-red-600 hover:text-red-800">Clear</button>
                          )}
                        </div>
                        <div className="grid grid-cols-3 gap-1 mb-2">
                          <input
                            type="date"
                            value={newDisbursement.date}
                            onChange={(e) => setNewDisbursement(prev => ({ ...prev, date: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                            placeholder="Date"
                          />
                          <input
                            type="number"
                            value={newDisbursement.amount}
                            onChange={(e) => setNewDisbursement(prev => ({ ...prev, amount: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                            placeholder="Amount"
                            onKeyPress={(e) => e.key === 'Enter' && addDisbursement()}
                          />
                          <button
                            onClick={addDisbursement}
                            className="bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold"
                          >
                            +
                          </button>
                        </div>
                        {disbursements.length > 0 && (
                          <div className="mt-2">
                            <div className="text-xs font-medium text-gray-700 mb-1">Added Disbursements:</div>
                            <div className="space-y-1 max-h-20 overflow-y-auto">
                              {disbursements.map((disb, idx) => (
                                <div key={idx} className="bg-green-50 rounded px-2 py-1 flex justify-between items-center text-xs">
                                  <span><strong>₹{disb.amount.toLocaleString('en-IN')}</strong> on {disb.date}</span>
                                  <button onClick={() => removeDisbursement(idx)} className="text-red-500 hover:text-red-700 font-bold ml-2">×</button>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>

                      {/* EMI Start Date Section */}
                      <div className="col-span-3">
                        <label className="block text-xs font-medium text-gray-700 mb-1">EMI Start Date</label>
                        <input
                          type="date"
                          value={loanData.emiStartDate || ''}
                          onChange={(e) => handleDateChange('emiStartDate', e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:ring-1 focus:ring-purple-200 outline-none"
                          placeholder="EMI Start Date"
                          title="First EMI Date (when EMI starts)"
                        />
                      </div>
                      <select
                        value={loanData.startMonth}
                        onChange={(e) => handleStartDateChange('startMonth', e.target.value)}
                            className="px-2 py-2 border border-gray-300 rounded text-sm focus:border-purple-500 outline-none"
                      >
                        {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(m => (
                          <option key={m} value={m}>{m}</option>
                        ))}
                      </select>
                      <input
                        type="number"
                        value={loanData.startYear}
                        onChange={(e) => handleStartDateChange('startYear', parseInt(e.target.value))}
                            className="col-span-2 px-3 py-2 border border-gray-300 rounded text-sm focus:border-purple-500 outline-none"
                            placeholder="Year"
                        min="2000"
                        max="2100"
                      />
                      {/* Interest basis hidden - using ACT/365 as standard */}
                    </div>
                    </div>

                      {/* ROI */}
                      <div className="bg-blue-50 rounded-lg p-3 border border-blue-200">
                        <div className="flex justify-between items-center mb-2">
                          <h3 className="text-sm font-bold text-blue-700">Interest Rate (ROI)</h3>
                    {roiPeriods.length > 1 && (
                            <button onClick={clearAllRoiPeriods} className="text-xs text-blue-600 hover:text-blue-800">Clear</button>
                    )}
                  </div>
                        <div className="grid grid-cols-4 gap-2 mb-2">
                      <select
                        value={newRoiPeriod.month}
                        onChange={(e) => setNewRoiPeriod(prev => ({ ...prev, month: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                      >
                        {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(m => (
                          <option key={m} value={m}>{m}</option>
                        ))}
                      </select>
                      <input
                        type="number"
                        value={newRoiPeriod.year}
                            onChange={(e) => setNewRoiPeriod(prev => ({ ...prev, year: parseInt(e.target.value) || new Date().getFullYear() }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                        placeholder="Year"
                      />
                      <input
                        type="number"
                        step="0.1"
                        value={newRoiPeriod.roi}
                            onChange={(e) => setNewRoiPeriod(prev => ({ ...prev, roi: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                        placeholder="ROI %"
                            onKeyPress={(e) => e.key === 'Enter' && addRoiPeriod()}
                      />
                      <button
                        onClick={addRoiPeriod}
                            className="bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-semibold"
                      >
                            +
                      </button>
                    </div>
                        {roiPeriods.length > 0 && (
                          <div className="space-y-1 max-h-24 overflow-y-auto">
                      {roiPeriods.map((roi, idx) => (
                              <div key={idx} className="bg-white rounded px-2 py-1 flex justify-between items-center text-xs">
                                <span><strong>{roi.roi}%</strong> from {roi.month} {roi.year}</span>
                                <button onClick={() => removeRoiPeriod(idx)} className="text-red-500 hover:text-red-700 font-bold">✕</button>
                        </div>
                      ))}
                    </div>
                  )}
                      </div>
                </div>

                    {/* Right Column - EMI + Prepayments */}
                    <div className="space-y-4">
                      {/* EMI */}
                      <div className="bg-orange-50 rounded-lg p-3 border border-orange-200">
                        <div className="flex justify-between items-center mb-2">
                          <h3 className="text-sm font-bold text-orange-700">EMI Amounts</h3>
                    {emiPeriods.length > 1 && (
                            <button onClick={clearAllEmiPeriods} className="text-xs text-orange-600 hover:text-orange-800">Clear</button>
                    )}
                  </div>
                        <div className="grid grid-cols-4 gap-2 mb-2">
                      <select
                        value={newEmiPeriod.month}
                        onChange={(e) => setNewEmiPeriod(prev => ({ ...prev, month: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                      >
                        {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(m => (
                          <option key={m} value={m}>{m}</option>
                        ))}
                      </select>
                      <input
                        type="number"
                        value={newEmiPeriod.year}
                            onChange={(e) => setNewEmiPeriod(prev => ({ ...prev, year: parseInt(e.target.value) || new Date().getFullYear() }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                        placeholder="Year"
                      />
                      <input
                        type="number"
                        value={newEmiPeriod.emi}
                            onChange={(e) => setNewEmiPeriod(prev => ({ ...prev, emi: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                            placeholder="EMI ₹"
                            onKeyPress={(e) => e.key === 'Enter' && addEmiPeriod()}
                      />
                      <button
                        onClick={addEmiPeriod}
                            className="bg-orange-600 hover:bg-orange-700 text-white rounded text-xs font-semibold"
                      >
                            +
                      </button>
                    </div>
                        {emiPeriods.length > 0 && (
                          <div className="space-y-1 max-h-24 overflow-y-auto">
                      {emiPeriods.map((emi, idx) => (
                              <div key={idx} className="bg-white rounded px-2 py-1 flex justify-between items-center text-xs">
                                <span><strong>₹{emi.emi.toLocaleString('en-IN')}</strong> from {emi.month} {emi.year}</span>
                                <button onClick={() => removeEmiPeriod(idx)} className="text-red-500 hover:text-red-700 font-bold">✕</button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                      {/* Prepayments */}
                      <div className="bg-green-50 rounded-lg p-3 border border-green-200">
                        <div className="flex justify-between items-center mb-2">
                          <h3 className="text-sm font-bold text-green-700">Prepayments</h3>
                    {prepayments.length > 0 && (
                            <button onClick={clearAllPrepayments} className="text-xs text-red-600 hover:text-red-800">Clear</button>
                    )}
                  </div>
                        <div className="grid grid-cols-4 gap-2 mb-2">
                      <select
                        value={newPrepayment.month}
                        onChange={(e) => setNewPrepayment(prev => ({ ...prev, month: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                      >
                        {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(m => (
                          <option key={m} value={m}>{m}</option>
                        ))}
                      </select>
                      <input
                        type="number"
                        value={newPrepayment.year}
                            onChange={(e) => setNewPrepayment(prev => ({ ...prev, year: parseInt(e.target.value) || new Date().getFullYear() }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                        placeholder="Year"
                      />
                      <input
                        type="number"
                        value={newPrepayment.amount}
                            onChange={(e) => setNewPrepayment(prev => ({ ...prev, amount: e.target.value }))}
                            className="px-2 py-1.5 border border-gray-300 rounded text-xs outline-none"
                            placeholder="Amount"
                            onKeyPress={(e) => e.key === 'Enter' && addPrepayment()}
                      />
                      <button
                        onClick={addPrepayment}
                            className="bg-green-600 hover:bg-green-700 text-white rounded text-xs font-semibold"
                      >
                            +
                      </button>
                        </div>
                        {prepayments.length > 0 && (
                          <div className="space-y-1 max-h-24 overflow-y-auto">
                            {prepayments.map((prep, idx) => (
                              <div key={idx} className="bg-white rounded px-2 py-1 flex justify-between items-center text-xs">
                                <span><strong>₹{prep.amount.toLocaleString('en-IN')}</strong> on {prep.month} {prep.year}</span>
                                <button onClick={() => removePrepayment(idx)} className="text-red-500 hover:text-red-700 font-bold">✕</button>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    </div>
                  </div>

                {!projectionData.summary.isEMISufficient && (
                  <div className="bg-red-500 rounded-xl shadow-lg p-5 mb-6 text-white border-2 border-red-400">
                    <div className="flex items-center gap-2 mb-3">
                      <TrendingDown />
                      <h3 className="text-lg font-bold">EMI Insufficient</h3>
                    </div>
                    <p className="text-sm mb-2">The loan calculation indicates the EMI may not be sufficient to fully repay the loan within a reasonable timeframe.</p>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3 text-sm">
                      <p><strong>Minimum EMI Suggested:</strong> ₹{projectionData.summary.minEMIRequired.toLocaleString('en-IN')}</p>
                      <p className="text-xs opacity-90 mt-1">Based on maximum monthly interest: ₹{Math.round(projectionData.summary.minEMIRequired / 1.01).toLocaleString('en-IN')}</p>
                      <p className="text-xs opacity-90 mt-2"><strong>If your current EMI is higher than this minimum:</strong></p>
                      <ul className="text-xs opacity-90 mt-1 ml-4 list-disc">
                        <li>Check your ROI and EMI change dates are correct</li>
                        <li>Verify disbursement dates and amounts</li>
                        <li>This warning may be due to very large disbursements</li>
                        <li>Open browser console (F12) for detailed debug info</li>
                      </ul>
                    </div>
                  </div>
                )}
                
                {projectionData.summary.totalPrepaymentsMade > 0 && projectionData.summary.interestSaved === 0 && (
                  <div className="bg-orange-500 rounded-xl shadow-lg p-5 mb-6 text-white border-2 border-orange-400">
                    <div className="flex items-center gap-2 mb-3">
                      <AlertCircle />
                      <h3 className="text-lg font-bold">Savings Calculation Issue</h3>
                    </div>
                    <p className="text-sm mb-2">You've made ₹{(projectionData.summary.totalPrepaymentsMade / 100000).toFixed(2)}L in prepayments, but savings show as ₹0.00L. This needs investigation.</p>
                    <div className="bg-white bg-opacity-20 rounded-lg p-3 text-sm">
                      <p><strong>Debug Steps:</strong></p>
                      <ol className="text-xs opacity-90 mt-2 ml-4 list-decimal space-y-1">
                        <li>Press <strong>F12</strong> to open browser console</li>
                        <li>Look for the section "SAVINGS CALCULATION DEBUG"</li>
                        <li>Check if "Without Prepayments" shows higher months/interest than "With Prepayments"</li>
                        <li>Share console output if issue persists</li>
                      </ol>
                      <p className="text-xs mt-2 opacity-90">
                        <strong>Common cause:</strong> Prepayment dates might not match your loan schedule months.
                      </p>
                    </div>
                  </div>
                )}

                {projectionData.schedule.length > 0 && (
                  <div className="bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl shadow-lg p-5 mb-6 text-white">
                    <div className="flex justify-between items-center mb-4">
                      <div className="flex items-center gap-2">
                        <PieChart />
                        <h3 className="text-lg font-bold">Loan Overview ({currentProfile})</h3>
                        </div>
                        <button
                        onClick={() => setShowDebugModal(true)}
                        className="bg-white text-blue-600 px-3 py-1.5 rounded-lg font-semibold text-xs hover:bg-opacity-90 transition-colors"
                        >
                        Details
                        </button>
                      </div>
                    
                    <div className="grid grid-cols-3 md:grid-cols-6 gap-3 text-center">
                      <div className="bg-white bg-opacity-15 rounded-lg p-2">
                        <p className="text-xs opacity-75">Principal</p>
                        <p className="font-bold text-sm">₹{(loanData.startingBalance / 100000).toFixed(1)}L</p>
                  </div>
                      <div className="bg-white bg-opacity-15 rounded-lg p-2">
                        <p className="text-xs opacity-75">ROI</p>
                        <p className="font-bold text-sm">{roiPeriods.length}</p>
                      </div>
                      <div className="bg-white bg-opacity-15 rounded-lg p-2">
                        <p className="text-xs opacity-75">EMI</p>
                        <p className="font-bold text-sm">{emiPeriods.length}</p>
                      </div>
                      <div className="bg-white bg-opacity-15 rounded-lg p-2">
                        <p className="text-xs opacity-75">Prepay</p>
                        <p className="font-bold text-sm">{prepayments.length}</p>
                      </div>
                      <div className="bg-white bg-opacity-15 rounded-lg p-2">
                        <p className="text-xs opacity-75">Duration</p>
                        <p className="font-bold text-sm">{Math.floor(projectionData.schedule.length / 12)}y {projectionData.schedule.length % 12}m</p>
                      </div>
                      <div className="bg-white bg-opacity-15 rounded-lg p-2">
                        <p className="text-xs opacity-75">Saved</p>
                        <p className="font-bold text-sm">{projectionData.summary.monthsSaved}m</p>
                      </div>
                    </div>
                    </div>
                  )}

                {motivationStats && projectionData.summary.isEMISufficient && (
                  <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg p-5 mb-6 text-white">
                    <div className="flex items-center gap-2 mb-4">
                      <Zap />
                      <h3 className="text-lg font-bold">Progress Tracker</h3>
                </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                      <div className="bg-white bg-opacity-15 rounded-lg p-4">
                        <div className="flex items-center gap-2 mb-2">
                          <Target />
                          <span className="text-sm font-semibold">EMI Power Ratio</span>
                        </div>
                        <div className="text-4xl font-bold">{motivationStats.currentRatio.toFixed(2)}x</div>
                        <p className="text-xs opacity-90 mt-1">₹1 interest = ₹{motivationStats.currentRatio.toFixed(2)} principal</p>
                      </div>

                      <div className="bg-white bg-opacity-15 rounded-lg p-4">
                        <div className="flex items-center gap-2 mb-2">
                          <TrendingUp />
                          <span className="text-sm font-semibold">Crossover Point</span>
                        </div>
                        {motivationStats.crossoverMonth ? (
                          <>
                            <div className="text-2xl font-bold">{motivationStats.crossoverMonth.month}</div>
                            <p className="text-xs opacity-90 mt-1">Principal beats interest!</p>
                          </>
                        ) : (
                          <p className="text-sm opacity-90">Add prepayments to reach faster</p>
                        )}
                      </div>
                    </div>

                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                      {motivationStats.milestones.map((milestone, idx) => (
                        <div 
                          key={idx}
                          className={`p-2 rounded text-center text-xs font-semibold ${
                            milestone.achieved 
                              ? 'bg-yellow-400 text-yellow-900' 
                              : 'bg-white bg-opacity-10'
                          }`}
                        >
                          {milestone.achieved && '✓ '}{milestone.title.replace('EMI Principal = ', '')}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {projectionData.schedule.length > 0 && roiPeriods.length > 1 && (
                  <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg p-4 mb-6 text-white">
                    <div className="flex items-center gap-2 mb-3">
                      <Calendar />
                      <h3 className="text-base font-bold">ROI Breakdown</h3>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                      {(() => {
                        const roiMonthCount = {};
                        projectionData.schedule.forEach(row => {
                          roiMonthCount[row.roi] = (roiMonthCount[row.roi] || 0) + 1;
                        });
                        return Object.entries(roiMonthCount).map(([roi, months]) => (
                          <div key={roi} className="bg-white bg-opacity-15 rounded-lg p-3 text-center">
                            <p className="text-2xl font-bold">{roi}%</p>
                            <p className="text-xs opacity-80">{months} months</p>
                          </div>
                        ));
                      })()}
                    </div>
                  </div>
                )}

                <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                  <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg p-4 text-white shadow">
                    <div className="flex items-center gap-1.5 mb-1.5">
                      <Calendar className="w-4 h-4" />
                      <p className="text-xs font-semibold">Last EMI</p>
                    </div>
                    <p className="text-xl font-bold">{projectionData.summary.lastEMIMonth}</p>
                    <p className="text-xs opacity-80 mt-0.5">{projectionData.summary.remainingMonths} months left</p>
                  </div>
                  <div className="bg-gradient-to-br from-yellow-500 to-orange-600 rounded-lg p-4 text-white shadow">
                    <div className="flex items-center gap-1.5 mb-1.5">
                      <TrendingUp className="w-4 h-4" />
                      <p className="text-xs font-semibold">Saved</p>
                    </div>
                    <p className="text-xl font-bold">{projectionData.summary.monthsSaved}m</p>
                    <p className="text-xs opacity-80 mt-0.5">vs {projectionData.summary.withoutPrepaymentMonths}m</p>
                  </div>
                  <div className="bg-gradient-to-br from-red-500 to-pink-600 rounded-lg p-4 text-white shadow">
                    <div className="flex items-center gap-1.5 mb-1.5">
                      <DollarSign className="w-4 h-4" />
                      <p className="text-xs font-semibold">Interest Saved</p>
                    </div>
                    <p className="text-xl font-bold">₹{(projectionData.summary.interestSaved / 100000).toFixed(1)}L</p>
                    <p className="text-xs opacity-80 mt-0.5">of ₹{(projectionData.summary.totalInterestPaid / 100000).toFixed(1)}L</p>
                  </div>
                  <div className="bg-gradient-to-br from-purple-500 to-violet-600 rounded-lg p-4 text-white shadow">
                    <div className="flex items-center gap-1.5 mb-1.5">
                      <PieChart className="w-4 h-4" />
                      <p className="text-xs font-semibold">Prepayments</p>
                    </div>
                    <p className="text-xl font-bold">₹{(projectionData.summary.totalPrepaymentsMade / 100000).toFixed(1)}L</p>
                    <p className="text-xs opacity-80 mt-0.5">{prepayments.length} payment{prepayments.length !== 1 ? 's' : ''}</p>
                  </div>
                </div>

                {/* Payment Schedule Section - Moved Up */}
                <div className="flex justify-end mb-4">
                  <button
                    onClick={exportToCSV}
                    className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg font-semibold text-sm shadow-md hover:shadow-lg transition-all"
                  >
                    <Download />
                    Export CSV
                  </button>
                </div>

                <div className="bg-white rounded-2xl shadow-2xl overflow-hidden mb-6">
                  {(() => {
                    const now = new Date();
                    const currentMonth = now.toLocaleString('en-US', { month: 'short' });
                    const currentYear = now.getFullYear();
                    const currentIndex = projectionData.schedule.findIndex(row => {
                      const [month, year] = row.month.split(' ');
                      return month === currentMonth && parseInt(year) === currentYear;
                    });
                    
                    let statusBadge = '';
                    if (currentIndex === -1) {
                      const loanStartDate = new Date(loanData.startYear, ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].indexOf(loanData.startMonth), 1);
                      if (now < loanStartDate) {
                        statusBadge = `📌 Starts ${loanData.startMonth} ${loanData.startYear}`;
                      } else {
                        statusBadge = '✅ Completed';
                      }
                    } else {
                      statusBadge = `📍 Current: ${currentMonth} ${currentYear}`;
                    }
                    
                    return (
                      <div className="bg-gradient-to-r from-indigo-600 to-purple-600 p-6">
                        <div className="flex justify-between items-center flex-wrap gap-3">
                    <div>
                            <h2 className="text-2xl font-bold text-white">Payment Schedule</h2>
                      <p className="text-sm text-indigo-100 mt-1">
                              {Math.floor(projectionData.summary.remainingMonths / 12)}y {projectionData.summary.remainingMonths % 12}m •
                              Final: {projectionData.summary.lastEMIMonth} • Current: {new Date().toLocaleDateString('en-IN', { month: 'short', year: 'numeric' })}
                    </p>
                  </div>
                    {projectionData.schedule.length > 13 && (
                      <button
                        onClick={() => setShowAllRows(!showAllRows)}
                              className="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 text-sm"
                      >
                              {showAllRows ? `Current Month` : `All ${projectionData.summary.remainingMonths} for remaining`}
                      </button>
                    )}
                </div>
                      </div>
                    );
                  })()}
                  
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-4 py-3 text-left">Month</th>
                          <th className="px-4 py-3 text-right">ROI %</th>
                          <th className="px-4 py-3 text-right">EMI</th>
                          <th className="px-4 py-3 text-right">Opening</th>
                          <th className="px-4 py-3 text-right">Interest</th>
                          <th className="px-4 py-3 text-right">EMI Principal</th>
                          <th className="px-4 py-3 text-right">Prepayment</th>
                          <th className="px-4 py-3 text-right">Closing</th>
                          <th className="px-4 py-3 text-right" title="EMI Principal ÷ Interest">
                            P/I Ratio
                          </th>
                          <th className="px-4 py-3 text-right bg-yellow-100" title="Months saved by prepayment">
                            <span className="font-bold text-yellow-800">Months Saved</span>
                          </th>
                        </tr>
                      </thead>
                      <tbody>
                        {(() => {
                          // Find current month index
                          const now = new Date();
                          const currentMonth = now.toLocaleString('en-US', { month: 'short' });
                          const currentYear = now.getFullYear();
                          
                          const currentIndex = projectionData.schedule.findIndex(row => {
                            const [month, year] = row.month.split(' ');
                            return month === currentMonth && parseInt(year) === currentYear;
                          });
                          
                          // Determine which rows to show
                          let displayRows;
                          if (showAllRows) {
                            displayRows = projectionData.schedule;
                          } else if (currentIndex !== -1) {
                            // Current month found - show 6 before and 6 after (13 total including current)
                            const start = Math.max(0, currentIndex - 6);
                            const end = Math.min(projectionData.schedule.length, currentIndex + 7);
                            displayRows = projectionData.schedule.slice(start, end);
                          } else {
                            // Current month not found - show first 12 months
                            displayRows = projectionData.schedule.slice(0, rowsToShow);
                          }
                          
                          return displayRows.map((row, index) => {
                            const actualIndex = showAllRows 
                              ? index 
                              : currentIndex !== -1 
                                ? Math.max(0, currentIndex - 6) + index 
                                : index;
                            const prevRow = actualIndex > 0 ? projectionData.schedule[actualIndex - 1] : null;
                          const roiChanged = prevRow && prevRow.roi !== row.roi;
                          const emiChanged = prevRow && prevRow.emi !== row.emi;
                            
                            // Check if this is the current month
                            const [rowMonth, rowYear] = row.month.split(' ');
                            const isCurrentMonth = rowMonth === currentMonth && parseInt(rowYear) === currentYear;
                          
                          return (
                            <tr key={index} className={
                              isCurrentMonth 
                                ? 'bg-yellow-200 border-y-2 border-yellow-400' 
                                : row.prepayment > 0 
                                  ? 'bg-purple-50' 
                                  : index % 2 === 0 
                                    ? 'bg-gray-50' 
                                    : ''
                            }>
                            <td className="px-4 py-3 font-semibold">
                              <div className="flex items-center gap-2">
                                {isCurrentMonth && <span className="text-yellow-600 font-bold">▶</span>}
                                {row.month}
                              </div>
                              {isCurrentMonth && <span className="text-xs text-yellow-700 font-bold block mt-0.5">(Current)</span>}
                            </td>
                              <td className="px-4 py-3 text-right">
                                <span className={roiChanged ? 'bg-yellow-200 px-2 py-1 rounded font-bold text-yellow-900' : ''}>
                                  {row.roi}%
                                </span>
                              </td>
                              <td className="px-4 py-3 text-right">
                                <span className={emiChanged ? 'bg-green-200 px-2 py-1 rounded font-bold text-green-900' : ''}>
                                  ₹{row.emi.toLocaleString('en-IN')}
                                </span>
                              </td>
                            <td className="px-4 py-3 text-right">₹{(row.openingBalance / 100000).toFixed(2)}L</td>
                            <td className="px-4 py-3 text-right text-red-600">₹{row.interest.toLocaleString('en-IN')}</td>
                            <td className="px-4 py-3 text-right text-green-600">₹{row.emiPrincipal.toLocaleString('en-IN')}</td>
                            <td className="px-4 py-3 text-right text-purple-600 font-bold">
                              {row.prepayment > 0 ? `₹${row.prepayment.toLocaleString('en-IN')}` : '-'}
                            </td>
                            <td className="px-4 py-3 text-right font-semibold">₹{(row.closingBalance / 100000).toFixed(2)}L</td>
                            <td className="px-4 py-3 text-right">
                              <span className={row.principalVsInterestRatio >= 1 ? 'text-green-600 font-bold' : 'text-orange-600'}>
                                {row.principalVsInterestRatio.toFixed(2)}x
                              </span>
                            </td>
                            <td className="px-4 py-3 text-right bg-yellow-50">
                                {row.monthsReduced > 0 ? (
                              <span className="bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold text-sm">
                                -{row.monthsReduced}m
                              </span>
                                ) : (
                                  <span className="text-gray-400">-</span>
                                )}
                            </td>
                          </tr>
                          );
                        });
                        })()}
                      </tbody>
                    </table>
                  </div>
                  
                  {!showAllRows && projectionData.schedule.length > 13 && (() => {
                    const now = new Date();
                    const currentMonth = now.toLocaleString('en-US', { month: 'short' });
                    const currentYear = now.getFullYear();
                    const currentIndex = projectionData.schedule.findIndex(row => {
                      const [month, year] = row.month.split(' ');
                      return month === currentMonth && parseInt(year) === currentYear;
                    });
                    
                    let displayCount;
                    if (currentIndex !== -1) {
                      const start = Math.max(0, currentIndex - 6);
                      const end = Math.min(projectionData.schedule.length, currentIndex + 7);
                      displayCount = end - start;
                    } else {
                      displayCount = Math.min(rowsToShow, projectionData.schedule.length);
                    }
                    
                    return (
                      <div className="bg-gray-50 p-4 text-center text-gray-600 text-sm">
                        Showing {displayCount} months around current month of {projectionData.schedule.length} total. Click "All {projectionData.schedule.length}" to see complete schedule.
                    </div>
                    );
                  })()}
                </div>

                {/* Key Dates and Tips Sections - Moved Down */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                  {/* Key Changes Box */}
                  <div className="bg-white rounded-xl shadow-lg p-5">
                    <div className="flex items-center gap-2 mb-3">
                      <Calendar />
                      <h3 className="text-lg font-bold text-gray-800">Key Dates</h3>
                    </div>
                    
                    <div className="space-y-4">
                      {/* ROI Changes */}
                      {roiPeriods.length > 1 && (
                        <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                          <h4 className="font-bold text-yellow-800 mb-2">Interest Rate Changes:</h4>
                          <div className="space-y-1">
                            {roiPeriods.map((roi, idx) => (
                              <div key={idx} className="text-sm text-gray-700">
                                <span className="font-semibold">{roi.month} {roi.year}:</span> {roi.roi}% p.a.
                                {idx === 0 && <span className="text-yellow-600 ml-2">(Starting)</span>}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      
                      {/* EMI Changes */}
                      {emiPeriods.length > 1 && (
                        <div className="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                          <h4 className="font-bold text-green-800 mb-2">EMI Changes:</h4>
                          <div className="space-y-1">
                            {emiPeriods.map((emi, idx) => (
                              <div key={idx} className="text-sm text-gray-700">
                                <span className="font-semibold">{emi.month} {emi.year}:</span> ₹{emi.emi.toLocaleString('en-IN')}
                                {idx === 0 && <span className="text-green-600 ml-2">(Starting)</span>}
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                      
                      {/* Prepayment Schedule */}
                      {prepayments.length > 0 && (
                        <div className="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                          <h4 className="font-bold text-purple-800 mb-2">Scheduled Prepayments:</h4>
                          <div className="space-y-1 max-h-32 overflow-y-auto">
                            {prepayments.slice(0, 10).map((prep, idx) => (
                              <div key={idx} className="text-sm text-gray-700">
                                <span className="font-semibold">{prep.month} {prep.year}:</span> ₹{prep.amount.toLocaleString('en-IN')}
                              </div>
                            ))}
                            {prepayments.length > 10 && (
                              <div className="text-xs text-purple-600">+ {prepayments.length - 10} more...</div>
                            )}
                          </div>
                        </div>
                      )}
                      
                      {/* Loan End Date */}
                      <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h4 className="font-bold text-blue-800 mb-2">Loan Completion:</h4>
                        <div className="text-sm text-gray-700">
                          <p className="font-semibold text-lg">{projectionData.summary.lastEMIMonth}</p>
                          <p className="text-xs text-blue-600 mt-1">Remaining: {projectionData.summary.remainingMonths} months ({Math.floor(projectionData.summary.remainingMonths / 12)} years {projectionData.summary.remainingMonths % 12} months)</p>
                          <p className="text-xs text-gray-500 mt-1">Total tenure: {projectionData.summary.totalMonths} months</p>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Tips & Info Box */}
                  <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl shadow-lg p-5">
                    <div className="flex items-center gap-2 mb-3">
                      <Award />
                      <h3 className="text-lg font-bold text-gray-800">Smart Tips</h3>
                    </div>
                    
                    <div className="space-y-3">
                      <div className={`p-4 rounded-lg shadow-sm ${projectionData.summary.interestSaved > 0 ? 'bg-white' : 'bg-red-50 border-2 border-red-300'}`}>
                        <h4 className={`font-bold mb-2 ${projectionData.summary.interestSaved > 0 ? 'text-indigo-700' : 'text-red-700'}`}>
                          {projectionData.summary.interestSaved > 0 ? 'Your Savings' : 'No Savings Calculated'}
                        </h4>
                        {projectionData.summary.interestSaved > 0 ? (
                          <p className="text-sm text-gray-700">
                            By making prepayments, you'll save <strong className="text-green-600">₹{(projectionData.summary.interestSaved / 100000).toFixed(2)}L</strong> in interest and finish <strong className="text-blue-600">{projectionData.summary.monthsSaved} months</strong> earlier!
                          </p>
                        ) : (
                          <div className="text-sm">
                            <p className="text-gray-700 mb-2">Savings show as ₹0.00L. Possible reasons:</p>
                            <ul className="list-disc ml-5 space-y-1 text-xs text-gray-600">
                              <li>No prepayments entered</li>
                              <li>Prepayment dates don't match loan schedule</li>
                              <li>Calculation issue</li>
                            </ul>
                            <p className="mt-3 text-xs bg-yellow-100 border border-yellow-300 rounded p-2 text-gray-800">
                              <strong>Debug:</strong> Press F12 to open console, look for "SAVINGS CALCULATION DEBUG"
                            </p>
                          </div>
                        )}
                      </div>
                      
                      <div className="bg-white p-4 rounded-lg shadow-sm">
                        <h4 className="font-bold text-purple-700 mb-2">Best Strategy</h4>
                        <p className="text-sm text-gray-700">
                          • Prepay when ROI is <strong>highest</strong><br/>
                          • Earlier prepayments save <strong>more</strong><br/>
                          • Even small amounts help significantly
                        </p>
                      </div>
                      
                      <div className="bg-white p-4 rounded-lg shadow-sm">
                        <h4 className="font-bold text-orange-700 mb-2">Progress Tracking</h4>
                        <p className="text-sm text-gray-700">
                          Principal-to-Interest ratio improving means you're paying more towards principal and less towards interest with each payment.
                        </p>
                      </div>
                      
                      <div className="bg-white p-4 rounded-lg shadow-sm">
                        <h4 className="font-bold text-green-700 mb-2">Auto-Save</h4>
                        <p className="text-sm text-gray-700">
                          All your data is automatically saved. Create multiple profiles to compare different scenarios!
                        </p>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Combined schedule section moved above - old quick view removed */}
                {false && projectionData.schedule.length >= 10 && (() => {
                  // Get current date
                  const now = new Date();
                  const currentMonth = now.toLocaleString('en-US', { month: 'short' });
                  const currentYear = now.getFullYear();
                  
                  // Find the index of current month in the schedule
                  const currentIndex = projectionData.schedule.findIndex(row => {
                    const [month, year] = row.month.split(' ');
                    return month === currentMonth && parseInt(year) === currentYear;
                  });
                  
                  // Determine which months to show
                  let startIdx, endIdx, displayMonths, statusMessage, isActualCurrent;
                  
                  if (currentIndex !== -1) {
                    // Current month found - show 5 before and 5 after (including current)
                    startIdx = Math.max(0, currentIndex - 5);
                    endIdx = Math.min(projectionData.schedule.length, currentIndex + 5);
                    displayMonths = projectionData.schedule.slice(startIdx, endIdx);
                    statusMessage = `Current Month: ${currentMonth} ${currentYear}`;
                    isActualCurrent = true;
                  } else if (now < new Date(loanData.startYear, ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].indexOf(loanData.startMonth), 1)) {
                    // Loan hasn't started yet
                    startIdx = 0;
                    endIdx = Math.min(10, projectionData.schedule.length);
                    displayMonths = projectionData.schedule.slice(startIdx, endIdx);
                    statusMessage = `Loan starts ${loanData.startMonth} ${loanData.startYear}`;
                    isActualCurrent = false;
                  } else {
                    // Loan has ended
                    startIdx = Math.max(0, projectionData.schedule.length - 10);
                    endIdx = projectionData.schedule.length;
                    displayMonths = projectionData.schedule.slice(startIdx, endIdx);
                    statusMessage = `Loan completed!`;
                    isActualCurrent = false;
                  }
                  
                  const currentRowIndex = currentIndex !== -1 ? currentIndex - startIdx : -1;
                  
                  return (
                    <div className="bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-600 rounded-2xl shadow-2xl p-6 mb-6 text-white">
                      <div className="flex justify-between items-center mb-4">
                        <div className="flex items-center gap-2">
                          <Target />
                          <h3 className="text-xl font-bold">📅 Quick View: Current Month Context</h3>
                        </div>
                        <div className="bg-white bg-opacity-20 px-4 py-2 rounded-lg">
                          <span className="text-xs opacity-80 block">{statusMessage}</span>
                          <span className="text-xs font-bold">
                            {isActualCurrent ? 'Live Data' : `Showing months ${startIdx + 1}-${endIdx}`}
                          </span>
                        </div>
                      </div>
                    
                      <div className="bg-white bg-opacity-10 backdrop-blur rounded-xl overflow-hidden">
                        <div className="overflow-x-auto">
                          <table className="w-full text-sm">
                            <thead className="bg-black bg-opacity-20">
                              <tr className="border-b border-white border-opacity-30">
                                <th className="px-3 py-3 text-left">Month</th>
                                <th className="px-3 py-3 text-right">ROI</th>
                                <th className="px-3 py-3 text-right">Opening</th>
                                <th className="px-3 py-3 text-right">EMI</th>
                                <th className="px-3 py-3 text-right">Interest</th>
                                <th className="px-3 py-3 text-right">Principal</th>
                                <th className="px-3 py-3 text-right">Prepayment</th>
                                <th className="px-3 py-3 text-right">Closing</th>
                                <th className="px-3 py-3 text-right">Months Saved</th>
                              </tr>
                            </thead>
                            <tbody>
                              {displayMonths.map((row, idx) => {
                                const isCurrentMonth = idx === currentRowIndex;
                                return (
                                  <tr key={idx} className={
                                    isCurrentMonth
                                      ? 'bg-yellow-400 bg-opacity-40 border-y-2 border-yellow-200' 
                                      : idx % 2 === 0 
                                        ? 'bg-white bg-opacity-5' 
                                        : ''
                                  }>
                                    <td className="px-3 py-3 font-semibold">
                                      <div className="flex items-center gap-2">
                                        {isCurrentMonth && <span className="text-yellow-300">▶</span>}
                                        <span>{row.month}</span>
                                      </div>
                                      <span className="text-xs opacity-70 block mt-0.5">
                                        {idx < currentRowIndex && '(Past)'}
                                        {isCurrentMonth && '(Current)'}
                                        {idx > currentRowIndex && '(Future)'}
                                        {!isActualCurrent && idx === Math.floor(displayMonths.length / 2) && '(Reference)'}
                                      </span>
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      <span className="text-xs">{row.roi}%</span>
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      <span className="font-semibold">₹{(row.openingBalance / 100000).toFixed(2)}L</span>
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      <span className="text-xs">₹{(row.emi / 1000).toFixed(0)}k</span>
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      <span className="bg-red-500 bg-opacity-90 px-2 py-1 rounded font-semibold text-white text-xs">
                                        ₹{(row.interest / 1000).toFixed(0)}k
                                      </span>
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      <span className="bg-green-500 bg-opacity-90 px-2 py-1 rounded font-semibold text-white text-xs">
                                        ₹{(row.emiPrincipal / 1000).toFixed(0)}k
                                      </span>
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      {row.prepayment > 0 ? (
                                        <span className="bg-purple-500 bg-opacity-90 px-2 py-1 rounded font-semibold text-white text-xs">
                                          ₹{(row.prepayment / 1000).toFixed(0)}k
                                        </span>
                                      ) : (
                                        <span className="opacity-50">-</span>
                                      )}
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      <span className="font-semibold">₹{(row.closingBalance / 100000).toFixed(2)}L</span>
                                    </td>
                                    <td className="px-3 py-3 text-right">
                                      {row.monthsReduced > 0 ? (
                                        <span className="bg-yellow-300 text-yellow-900 px-2 py-1 rounded font-bold text-xs">
                                          -{row.monthsReduced}
                                        </span>
                                      ) : (
                                        <span className="opacity-50">-</span>
                                      )}
                                    </td>
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      </div>
                      
                      <div className="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                        <div className="bg-white bg-opacity-10 rounded-lg p-3">
                          <p className="opacity-80 text-xs mb-1">Balance Progress</p>
                          <p className="font-bold">
                            ₹{(displayMonths[0]?.openingBalance / 100000).toFixed(2)}L → ₹{(displayMonths[displayMonths.length - 1]?.closingBalance / 100000).toFixed(2)}L
                          </p>
                        </div>
                        <div className="bg-white bg-opacity-10 rounded-lg p-3">
                          <p className="opacity-80 text-xs mb-1">Total Prepayments (Period)</p>
                          <p className="font-bold">
                            ₹{(displayMonths.reduce((sum, row) => sum + row.prepayment, 0) / 100000).toFixed(2)}L
                          </p>
                        </div>
                        <div className="bg-white bg-opacity-10 rounded-lg p-3">
                          <p className="opacity-80 text-xs mb-1">Months Saved (Period)</p>
                          <p className="font-bold">
                            {displayMonths.reduce((sum, row) => sum + row.monthsReduced, 0)} months
                          </p>
                        </div>
                      </div>
                      
                      <div className="mt-4 text-sm bg-emerald-700 bg-opacity-30 rounded-lg p-3">
                        <p className="flex items-center gap-2">
                          <span className="text-yellow-300">Tip:</span>
                          <span>
                            {isActualCurrent 
                              ? `Showing your actual current month (${currentMonth} ${currentYear}) with 5 months before and after for context.`
                              : statusMessage === 'Loan completed!'
                                ? 'Your loan is complete! Showing the final months of your payment schedule.'
                                : `Your loan starts in ${loanData.startMonth} ${loanData.startYear}. Showing initial months for planning.`
                            }
                          </span>
                        </p>
                      </div>
                    </div>
                  );
                })()}

                {/* Floating Action Buttons */}
                <div className="fixed right-6 bottom-24 z-40 flex flex-col gap-3">
                  <a
                    href="https://buymeacoffee.com/snickers9"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="group bg-gradient-to-r from-yellow-400 to-yellow-500 hover:from-yellow-500 hover:to-yellow-600 text-gray-900 px-6 py-4 rounded-full font-bold transition-all shadow-2xl hover:shadow-3xl hover:scale-110 flex items-center gap-3"
                    title="Support LoanWise"
                  >
                    <span className="text-2xl">☕</span>
                    <span className="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 whitespace-nowrap">Support</span>
                  </a>
                  
                  <button
                    onClick={() => setShowShareModal(true)}
                    className="group bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white px-6 py-4 rounded-full font-bold transition-all shadow-2xl hover:shadow-3xl hover:scale-110 flex items-center gap-3"
                    title="Share LoanWise"
                  >
                    <span className="text-2xl">❤️</span>
                    <span className="max-w-0 overflow-hidden group-hover:max-w-xs transition-all duration-300 whitespace-nowrap">Share</span>
                  </button>
                </div>

                {/* Support Section - Compact */}
                <div className="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 rounded-xl shadow-lg p-5 mb-6 text-white">
                  <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div className="text-center md:text-left">
                      <h3 className="text-lg font-bold mb-1">💜Enjoying LoanWise?</h3>
                      <p className="text-sm opacity-90">100% FREE • No Ads • Support if you found value!</p>
                    </div>
                    
                    <div className="flex flex-wrap justify-center gap-2">
                      <a
                        href="https://buymeacoffee.com/snickers9"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="bg-yellow-500 hover:bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg flex items-center gap-1.5"
                      >
                        <span>Support</span>
                        <span>Support</span>
                      </a>
                      
                      <button
                        onClick={() => setShowShareModal(true)}
                        className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg flex items-center gap-1.5"
                      >
                        <span>Share</span>
                        <span>Share</span>
                      </button>
                      
                      <a
                        href="mailto:didyouknowmyemail@gmail.com?subject=LoanWise - Feedback"
                        className="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-semibold text-sm transition-all shadow-md hover:shadow-lg flex items-center gap-1.5"
                      >
                        <span>Feedback</span>
                        <span>Feedback</span>
                      </a>
                    </div>
                  </div>
                </div>

                {/* Footer */}
                <div className="text-center text-gray-400 text-sm pb-8 space-y-4">
                  <div className="flex justify-center mb-3">
                    <div className="bg-gray-800 rounded-lg p-2">
                      <LoanWiseLogo size="40" />
                    </div>
                  </div>
                  <p className="text-lg">
                    <span className="text-purple-400 font-bold">LoanWise</span>
                  </p>
                  <p className="text-yellow-500 font-semibold text-sm">Make Smarter Loan Decisions</p>
                  <p>© {new Date().getFullYear()} - Free Loan Planning Tool by LoanWise</p>
                  <p className="text-xs opacity-70 max-w-2xl mx-auto">
                    Plan your EMI • Track Prepayments • Variable ROI Support • Save Thousands in Interest
                  </p>
                  <div className="flex justify-center gap-4 text-xs mt-4">
                    <a href="https://buymeacoffee.com/snickers9" target="_blank" rel="noopener noreferrer" className="text-purple-400 hover:text-purple-300 transition-colors">Support</a>
                    <span className="text-gray-600">|</span>
                    <a href="mailto:didyouknowmyemail@gmail.com" className="text-purple-400 hover:text-purple-300 transition-colors">Contact</a>
                  </div>
                </div>

              </div>
            </div>
          );
        }

        ReactDOM.render(<SmartLoanProjectionCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
</html>
